<html><head><link rel="stylesheet" href="/sssd-test2/trac.css" type="text/css" /><link rel="stylesheet" href="/sssd-test2/wiki.css" type="text/css" /></head><body><p>
</p><div class="wiki-toc">
<ol>
  <li>
    <ol>
      <li>
        <a href="#Synopsis">Synopsis</a>
      </li>
      <li>
        <a href="#RequiredSoftware">Required Software</a>
      </li>
      <li>
        <a href="#WindowsServerSetup">Windows Server Setup</a>
        <ol>
          <li>
            <a href="#OperatingSystemInstallation">Operating System Installation</a>
          </li>
          <li>
            <a href="#DomainConfiguration">Domain Configuration</a>
          </li>
          <li>
            <a href="#GlobalCatalogConfiguration">Global Catalog Configuration</a>
          </li>
        </ol>
      </li>
      <li>
        <a href="#Clientconfiguration">Client configuration</a>
        <ol>
          <li>
            <a href="#DNSconfiguration">DNS configuration</a>
          </li>
          <li>
            <a href="#JoiningtheLinuxclientusingrealmd">Joining the Linux client using realmd</a>
          </li>
          <li>
            <a href="#Accesscontroloptions">Access control options</a>
          </li>
          <li>
            <a href="#JoiningtheLinuxclienttotheADdomainmanually">Joining the Linux client to the AD domain manually</a>
            <ol>
              <li>
                <ol>
                  <li>
                    <a href="#CreatingHostKeytabwithSamba">Creating Host Keytab with Samba</a>
                  </li>
                </ol>
              </li>
              <li>
                <a href="#etckrb5.conf">/etc/krb5.conf</a>
                <ol>
                  <li>
                    <a href="#etcsambasmb.conf">/etc/samba/smb.conf</a>
                  </li>
                </ol>
              </li>
            </ol>
          </li>
          <li>
            <a href="#CreatingServiceKeytabonAD">Creating Service Keytab on AD</a>
          </li>
        </ol>
      </li>
      <li>
        <a href="#SSSDsetup">SSSD setup</a>
        <ol>
          <li>
            <a href="#etcsssdsssd.conf">/etc/sssd/sssd.conf</a>
          </li>
          <li>
            <a href="#NSSPAMConfiguration">NSS/PAM Configuration</a>
            <ol>
              <li>
                <a href="#FedoraRHEL">Fedora/RHEL</a>
              </li>
              <li>
                <a href="#DebianUbuntu">Debian/Ubuntu</a>
              </li>
              <li>
                <a href="#ConfigureNSSPAMmanually">Configure NSS/PAM manually</a>
                <ol>
                  <li>
                    <a href="#etcnsswitch.conf">/etc/nsswitch.conf</a>
                  </li>
                  <li>
                    <a href="#etcpam.dcommon-auth">/etc/pam.d/common-auth</a>
                  </li>
                  <li>
                    <a href="#etcpam.dcommon-account">/etc/pam.d/common-account</a>
                  </li>
                  <li>
                    <a href="#etcpam.dcommon-password">/etc/pam.d/common-password</a>
                  </li>
                  <li>
                    <a href="#etcpam.dcommon-session">/etc/pam.d/common-session</a>
                  </li>
                </ol>
              </li>
            </ol>
          </li>
        </ol>
      </li>
      <li>
        <a href="#UnderstandingKerberosActiveDirectory">Understanding Kerberos &amp; Active Directory</a>
        <ol>
          <li>
            <a href="#OptionalFinalTest">Optional Final Test</a>
          </li>
          <li>
            <a href="#Furtherreading">Further reading</a>
          </li>
        </ol>
      </li>
    </ol>
  </li>
</ol>
</div><p>
</p>
<h2 id="Synopsis">Synopsis</h2>
<p>
This page describes how to configure SSSD to authenticate with a Windows 2008 or later Domain Server using the <a class="ext-link" href="http://jhrozek.fedorapeople.org/sssd/git/man/sssd-ad.5.html"><span class="icon">​</span>Active Directory provider</a>. This guide is a work in progress.
</p>
<h2 id="RequiredSoftware">Required Software</h2>
<p>
The AD provider was first introduced with SSSD 1.9.0. If you are using an older SSSD version, follow the <a class="ext-link" href="https://docs.pagure.org/sssd-test2/Configuring%20sssd%20to%20authenticate%20with%20a%20Windows%202008%20Domain%20Server.html"><span class="icon">​</span>guide on configuring the LDAP provider with Active Directory</a>.
</p>
<h2 id="WindowsServerSetup">Windows Server Setup</h2>
<p>
The domain to be configured is <em>ad.example.com</em> using realm <em>AD.EXAMPLE.COM</em>. The Windows server has the hostname of <em>server.ad.example.com</em>, and the client host where SSSD is running is called <em>client.ad.example.com</em>. Reboot Windows during installation and setup when prompted and complete the needed steps as Administrator.
</p>
<p>
The Active Directory provider is able to either map the Windows Security Identifiers (SIDs) into POSIX IDs or use the POSIX IDs that are set on the AD server. By default, the AD provider uses the automatic ID mapping method. In order to use the POSIX IDs, you need to set up <a class="ext-link" href="http://technet.microsoft.com/en-us/library/cc731178.aspx"><span class="icon">​</span>Identity Management for UNIX</a>. Please note that starting with Windows Server 2016, the <a class="ext-link" href="https://blogs.technet.microsoft.com/activedirectoryua/2016/02/09/identity-management-for-unix-idmu-is-deprecated-in-windows-server/"><span class="icon">​</span>Identity Management for UNIX UI is deprecated</a>. However, it is still possible to set the POSIX attributes. For managing POSIX attributes in environments with IPA-AD trusts deployed, the <a class="ext-link" href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Linux_Domain_Identity_Authentication_and_Policy_Guide/id-views.html"><span class="icon">​</span>ID views feature</a> of IDM might also be interesting.
</p>
<h3 id="OperatingSystemInstallation">Operating System Installation</h3>
<ul><li>Boot from the Windows 2012 Server DVD
</li><li>Install Windows 2012 Server and set the computer name to <em>server</em>
</li></ul><h3 id="DomainConfiguration">Domain Configuration</h3>
<ul><li>In <em>Server Manager</em> add the <em>Active Directory Domain Services</em> role
</li><li>Create a new domain named <em>ad.example.com</em>
</li><li>Make sure <em>server.ad.example.com</em> is resolvable in DNS
</li></ul><h3 id="GlobalCatalogConfiguration">Global Catalog Configuration</h3>
<p>
When working with multiple trusted domains, SSSD often reads the data from the Global Catalog first. However, POSIX attributes such as UIDs or GIDs are not replicated to the Global Catalog by default. For performance reasons, it might be a good idea to set them to be replicated manually. This recommendation applies to setups that do not use automatic ID mapping and use <tt>ldap_id_mapping=False</tt> instead.
</p>
<ul><li>Install the Identity Management for UNIX Components
<ul><li>Please follow this <a class="ext-link" href="http://technet.microsoft.com/en-us/library/cc731178.aspx"><span class="icon">​</span>article</a> to install Identity Management for UNIX on primary and child domains controllers
</li><li>After the installation has finished, you'll be able to assign POSIX UID, GID and other attributes using a tab called <em>UNIX Attributes</em> in the <em>Properties</em> menu
</li></ul></li><li>Setup Schema Snap-in
<ul><li>To enable new attributes to replicate to the GC we need an Active Directory Schema snap-in. Follow <a class="ext-link" href="http://technet.microsoft.com/en-us/library/cc755885%28v=ws.10%29.aspx"><span class="icon">​</span>this article</a> to install the Schema Snap-In
</li></ul></li><li>Modify Attributes for replication
<ul><li>The following <a class="ext-link" href="http://support.microsoft.com/kb/248717"><span class="icon">​</span>article</a> explains how to select any attribute for replication
</li><li>In our case, select <em>uidNumber</em>, <em>gidNumber</em>, <em>unixHomeDirectory</em> and <em>loginShell</em>
</li></ul></li><li>Verifying Attributes replication to Global Catalog
<ul><li>In general, search for a user entry that has the POSIX attributes set on port 3268 of a Domain Controller
</li><li>You can use the <em>LDP</em> tool from Windows or later, when the Linux machine is joined, simply <em>ldapsearch</em>
</li></ul></li></ul><h2 id="Clientconfiguration">Client configuration</h2>
<p>
The client configuration consists of several steps, each of which can be either performed manually or using a configuration tool such as <a class="ext-link" href="http://freedesktop.org/software/realmd/"><span class="icon">​</span>realmd</a>. The latter is always recommended due to the ease of use and correctness of the resulting configuration. Let's first take a look at the automated procedure first.
</p>
<h3 id="DNSconfiguration">DNS configuration</h3>
<p>
It is recommended that the Linux client you are enrolling is able to resolve the SRV records the Active directory publishes. In order to do so, the clients would typically point at the AD DCs in <tt>/etc/resolv.conf</tt>. You can verify this using dig:
</p>
<pre class="wiki">dig -t SRV  _ldap._tcp.ad.example.com @server.ad.example.com
</pre><h3 id="JoiningtheLinuxclientusingrealmd">Joining the Linux client using realmd</h3>
<p>
The realmd (Realm Discovery) project is a system service that manages discovery and enrolment to several centralized domains including AD or IPA. realmd is included in several popular Linux distributions including:
</p>
<ul><li>Red Hat Enterprise Linux 7.0 and later
</li><li>Fedora 19 and later
</li><li>Ubuntu 13.04 and later
</li><li>Debian 8.0 and later
</li></ul><p>
Run <tt>realm discover</tt> to see what domains realmd can find. Note that this functionality relies on NetworkManager being up and running in order to read the DHCP domain:
</p>
<pre class="wiki">realm discover
</pre><p>
Alternatively, you can specify the realm yourself. This functionality only relies on DNS being set up correctly, typically by pointing <tt>/etc/resolv.conf</tt> to the AD DC.
</p>
<pre class="wiki">realm discover AD.EXAMPLE.COM
</pre><p>
Finally, joining the Active Directory domain is as easy as:
</p>
<pre class="wiki">realm join AD.EXAMPLE.COM
</pre><p>
You will be prompted for Administrator password. However, realmd supports more enrolment options, including using a one-time password or selecting a custom OU. Refer to the <a class="ext-link" href="http://freedesktop.org/software/realmd/docs/"><span class="icon">​</span>realmd documentation</a> for more details.
</p>
<p>
Please note that the <tt>realm permit</tt> command configures the simple access provider.
</p>
<h3 id="Accesscontroloptions">Access control options</h3>
<p>
There is a number of access control options available to a directly-enrolled AD client machine.
</p>
<ul><li><tt>access_provider=simple</tt>
<ul><li>Pros: Very simple. Supports nested groups, because the user entry is fully evaluated on login first and then the simple access provider runs.
</li><li>Cons: Does not support any more expresiveness than allow/deny a user or a group.
</li></ul></li><li><tt>access_provider=ad</tt>
<ul><li>Pros: Supports fully centralized environments by using GPOs for access control
</li><li>Cons: Not supported with older releases
</li></ul></li><li><tt>ad_access_filter</tt>
<ul><li>Pros: Very expressive, can be used to allow/deny based on any properties of the LDAP user object. The filter is applied on the user entry in LDAP, not the cached entry, which might have implications on evaluating nested group memberships.
</li><li>Cons: Cumbersome to write
</li></ul></li></ul><p>
It is also possible to use completely external means of access control, such as <tt>pam_access.so</tt>. Those might be useful when supporting legacy stack alongside SSSD or when defining access control by means SSSD doesn't support (such as per netgroup).
</p>
<h3 id="JoiningtheLinuxclienttotheADdomainmanually">Joining the Linux client to the AD domain manually</h3>
<p>
The manual process of joining the Linux client to the AD domain consists of several steps:
</p>
<ul><li>Acquiring the host keytab with Samba or create it using ktpass on the AD controller
</li><li>Configuring sssd.conf
</li><li>Configuring the system to use the SSSD for identity information and authentication
</li></ul><h5 id="CreatingHostKeytabwithSamba">Creating Host Keytab with Samba</h5>
<p>
On the Linux client with properly configured <tt>/etc/krb5.conf</tt> (see below) and suitable <tt>/etc/samba/smb.conf</tt>:
</p>
<h4 id="etckrb5.conf">/etc/krb5.conf</h4>
<pre class="wiki">[logging]
 default = FILE:/var/log/krb5libs.log

[libdefaults]
 default_realm = AD.EXAMPLE.COM
 dns_lookup_realm = true
 dns_lookup_kdc = true
 ticket_lifetime = 24h
 renew_lifetime = 7d
 forwardable = true
 rdns = false

# You may also want either of:
# allow_weak_crypto = true
# default_tkt_enctypes = arcfour-hmac

[realms]
# Define only if DNS lookups are not working
# AD.EXAMPLE.COM = {
#  kdc = server.ad.example.com
#  master_kdc = server.ad.example.com
#  admin_server = server.ad.example.com
# }

[domain_realm]
# Define only if DNS lookups are not working
# .ad.example.com = AD.EXAMPLE.COM
# ad.example.com = AD.EXAMPLE.COM
</pre><p>
Make sure <tt>kinit aduser@AD.EXAMPLE.COM</tt> works properly. If not, using <tt>KRB5_TRACE</tt> usually provides helpful information: <tt>KRB5_TRACE=/dev/stdout kinit -V aduser@AD.EXAMPLE.COM</tt>.
</p>
<h5 id="etcsambasmb.conf">/etc/samba/smb.conf</h5>
<pre class="wiki">[global]
   security = ads
   realm = AD.EXAMPLE.COM
   workgroup = EXAMPLE

   log file = /var/log/samba/%m.log

   kerberos method = secrets and keytab

   client signing = yes
   client use spnego = yes
</pre><p>
Now join the client with:
</p>
<pre class="wiki">kinit Administrator
net ads join -k
</pre><p>
Alternatively, without using the Kerberos ticket:
</p>
<pre class="wiki">net ads join -U Administrator
</pre><p>
 
Additional principals can be created later with <tt>net ads keytab add</tt> if needed.
</p>
<p>
You don't need a Domain Administrator account to do this, you just need an account with sufficient rights to join a machine to the domain. This is a notable advantage of this approach over generating the keytab directly on the AD controller. 
</p>
<p>
To verify the keytab was acquired correctly and can be used to access AD:
</p>
<pre class="wiki">klist -ke
kinit -k CLIENT\$@AD.EXAMPLE.COM
</pre><p>
Now using this credential you've just created try fetching data from the server with <em>ldapsearch</em> (in case of issues make sure <tt>/etc/openldap/ldap.conf</tt> does not contain any unwanted settings):
</p>
<pre class="wiki">/usr/bin/ldapsearch -H ldap://server.ad.example.com/ -Y GSSAPI -N -b "dc=ad,dc=example,dc=com" "(&amp;(objectClass=user)(sAMAccountName=aduser))"
</pre><p>
By using the credential from the keytab, you've verified that this credential has sufficient rights to retrieve user information.
</p>
<p>
You can also check if searching the Global Catalog works and whether the attributes your environment depends on are replicated to the Global Catalog:
</p>
<pre class="wiki">/usr/bin/ldapsearch -H ldap://server.ad.example.com:3268 -Y GSSAPI -N -b "dc=ad,dc=example,dc=com" "(&amp;(objectClass=user)(sAMAccountName=aduser))"
</pre><p>
After both <em>kinit</em> and <em>ldapsearch</em> work properly proceed to actual SSSD configuration.
</p>
<h3 id="CreatingServiceKeytabonAD">Creating Service Keytab on AD</h3>
<p>
Do not do this step if you've already created a keytab using Samba. This part of the guide might be useful if the password for Administrator or another user who is able to enroll computers can't be shared.
</p>
<p>
On the Windows server:
</p>
<ul><li>Open Users &amp; Computers snap-in
</li><li>Create a new Computer object named client (i.e., the name of the host running SSSD)
</li><li>On the command prompt:
<pre class="wiki">setspn -A host/client.ad.example.com@AD.EXAMPLE.COM client
setspn -L client
ktpass /princ host/client.ad.example.com@AD.EXAMPLE.COM /out client-host.keytab /crypto all /ptype KRB5_NT_PRINCIPAL -desonly /mapuser AD\client$ +setupn +rndPass +setpass +answer
</pre><ul><li>This sets the machine account password and UPN for the principal
</li><li>If you create additional keytabs for the host add <tt>-setpass -setupn</tt> for the above command to prevent resetting the machine password (thus changing kvno) and to prevent overwriting the UPN 
</li><li><a href="http://fedorahosted.org/sssd/attachment/wiki/Configuring_sssd_with_ad_server/create-sssd-keytab.ps1">Powershell script available below</a>
</li></ul></li><li>Transfer the keytab created in a secure manner to the client as /etc/krb5.keytab and make sure its permissions are correct:
<ul><li><tt>chown root:root /etc/krb5.keytab</tt>
</li><li><tt>chmod 0600 /etc/krb5.keytab</tt>
</li><li><tt>restorecon /etc/krb5.keytab</tt>
</li></ul></li></ul><p>
See the Linux Client Setup section for verifying the keytab file and the example sssd.conf below for the needed SSSD configuration.
</p>
<h2 id="SSSDsetup">SSSD setup</h2>
<p>
Configuring SSSD consists of several steps:
</p>
<ul><li>Install the <em>sssd-ad</em> package on the Linux client machine
<ul><li>With older distributions (RHEL 6.5 and earlier for example) you might need to install the full <em>sssd</em> package.
</li></ul></li><li>Make configuration changes to the files below
</li><li>Start the <em>sssd</em> service
</li></ul><h3 id="etcsssdsssd.conf">/etc/sssd/sssd.conf</h3>
<p>
Example <em>sssd.conf</em> configuration, additional options can be added as needed.
</p>
<pre class="wiki">[sssd]
config_file_version = 2
domains = ad.example.com
services = nss, pam

[domain/ad.example.com]
# Uncomment if you need offline logins
# cache_credentials = true

id_provider = ad
auth_provider = ad
access_provider = ad

# Uncomment if service discovery is not working
# ad_server = server.ad.example.com

# Uncomment if you want to use POSIX UIDs and GIDs set on the AD side
# ldap_id_mapping = False

# Comment out if the users have the shell and home dir set on the AD side
default_shell = /bin/bash
fallback_homedir = /home/%d/%u

# Uncomment and adjust if the default principal SHORTNAME$@REALM is not available
# ldap_sasl_authid = host/client.ad.example.com@AD.EXAMPLE.COM

# Comment out if you prefer to user shortnames.
use_fully_qualified_names = True
</pre><p>
Set the file ownership and permissions on sssd.conf
</p>
<pre class="wiki">chown root:root /etc/sssd/sssd.conf
chmod 0600 /etc/sssd/sssd.conf
restorecon /etc/sssd/sssd.conf
</pre><h3 id="NSSPAMConfiguration">NSS/PAM Configuration</h3>
<p>
Depending on your distribution you have different options how to enable SSSD.
</p>
<h4 id="FedoraRHEL">Fedora/RHEL</h4>
<p>
Use <em>authconfig</em> to enable SSSD, install <em>oddjob-mkhomedir</em> to make sure home directory creation works with SELinux:
</p>
<pre class="wiki">authconfig --enablesssd --enablesssdauth --enablemkhomedir --update
</pre><h4 id="DebianUbuntu">Debian/Ubuntu</h4>
<p>
Install <em>libnss-sss</em> and <em>libpam-sss</em> to have SSSD added as NSS/PAM provider in <tt>/etc/nsswitch.conf</tt> and <tt>/etc/pam.d/common-*</tt> configuration files. Add <em>pam_mkhomedir.so</em> to PAM session configuration manually. Restart SSSD after these changes.
</p>
<h4 id="ConfigureNSSPAMmanually">Configure NSS/PAM manually</h4>
<p>
Manual configuration can be done with the following changes. The file paths for PAM in the example below are from Debian/Ubuntu, in Fedora/RHEL corresponding manual configuration should be done in <tt>/etc/pam.d/system-auth</tt> and <tt>/etc/pam.d/password-auth</tt>.
</p>
<h5 id="etcnsswitch.conf">/etc/nsswitch.conf</h5>
<pre class="wiki">#
# /etc/nsswitch.conf
#

passwd:         files sss
shadow:         files sss
group:          files sss

hosts:          files dns

bootparams:     files

ethers:         files
netmasks:       files
networks:       files
protocols:      files
rpc:            files
services:       files sss

netgroup:       files sss

publickey:      files

automount:      files
aliases:        files
</pre><h5 id="etcpam.dcommon-auth">/etc/pam.d/common-auth</h5>
<p>
Right after the <em>pam_unix.so</em> line, add
</p>
<pre class="wiki">auth         sufficient    pam_sss.so use_first_pass
</pre><h5 id="etcpam.dcommon-account">/etc/pam.d/common-account</h5>
<p>
Right after the <em>pam_unix.so</em> line, add
</p>
<pre class="wiki">account      [default=bad success=ok user_unknown=ignore] pam_sss.so
</pre><h5 id="etcpam.dcommon-password">/etc/pam.d/common-password</h5>
<p>
Right after the <em>pam_unix.so</em> line, add
</p>
<pre class="wiki">password     sufficient    pam_sss.so use_authtok
</pre><h5 id="etcpam.dcommon-session">/etc/pam.d/common-session</h5>
<p>
Just before the <em>pam_unix.so</em> line, add
</p>
<pre class="wiki">session      optional      pam_mkhomedir.so
</pre><p>
Right after the <em>pam_unix.so</em> line, add
</p>
<pre class="wiki">session      optional      pam_sss.so
</pre><h2 id="UnderstandingKerberosActiveDirectory">Understanding Kerberos &amp; Active Directory</h2>
<p>
It is important to understand that (unlike Linux MIT based KDC) Active Directory based KDC divides Kerberos principals into two groups:
</p>
<ul><li><em>User Principals</em> - usually equals to the sAMAccountname attribute of the object in AD. In short, User Principal is entitled to obtain TGT (ticket granting ticket). User Principals could be hence used to generate a TGT via <tt>kinit -k &lt;principalname&gt;</tt>
</li><li><em>Service Principals</em> - represents which Kerberized service can be used on the computer in question. Service principals can NOT be used to obtain a TGT and can not be used to grant access to a Active Directory controller for example.
</li></ul><p>
Each user object in Active Directory (understand that a computer object in AD is de-facto user object as well) can have:
</p>
<ul><li>maximum of 2 User Principal Names (UPN). One is pre-defined by the previously mentioned <em>sAMAccountName</em> LDAP attribute (for computer objects it will be in the form of <em>&lt;shortname&gt;$</em>) and the second by its <em>UserPrincipalName</em> string attribute
</li><li>many Service Principal Names (typically one for each Kerberized service we want to enable on the computer) defined by the <em>ServicePrincipalName</em> (SPN) list attribute. The attributes can be seen/set using the ADSIedit snap-in for example.
</li></ul><h3 id="OptionalFinalTest">Optional Final Test</h3>
<p>
You may have made iterative changes to your setup while learning about SSSD. To make sure that your setup actually works, and you're not relying on cached credentials, or cached LDAP information, you may want to clear out the local cache. Obviously this will erase local credentials, and all cached user information, so you should only do this for testing, and while on the network with network access to the AD servers.
</p>
<pre class="wiki">service sssd stop
rm -f /var/lib/sss/db/*
rm -f /var/lib/sss/mc/*
service sssd start
getent passwd administrator@ad.example.com
</pre><p>
If all looks well on your system after this, you know that sssd is able to use the kerberos and ldap services you've configured.
</p>
<p>
The example configuration enforces the use of <em>fully qualified names</em>. This restriction will force all lookups to contain the domain name as well, either the full domain name as specified in sssd.conf (<tt>getent passwd administrator@ad.example.com</tt>) or the short NetBIOS name (<tt>getent passwd AD\\Administrator</tt>). This restriction helps separate users from different domains, especially in setups with multiple domains in a trusted environment, or in cases where local UNIX users might have the same user names as AD users.
</p>
<h3 id="Furtherreading">Further reading</h3>
<p>
Please see the following article on Technet site (<a class="ext-link" href="http://technet.microsoft.com/en-us/library/cc772815%28WS.10%29.aspx"><span class="icon">​</span>http://technet.microsoft.com/en-us/library/cc772815%28WS.10%29.aspx</a>) for more in-depth Kerberos understanding
</p>
</body></html>