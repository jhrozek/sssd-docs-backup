<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Matching and Mapping Certificates &#8212; sssd 1.15.1 documentation</title>
    
    <link rel="stylesheet" href="../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.15.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="nav-item nav-item-0"><a href="../index.html">sssd 1.15.1 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="matching-and-mapping-certificates">
<h1>Matching and Mapping Certificates<a class="headerlink" href="#matching-and-mapping-certificates" title="Permalink to this headline">¶</a></h1>
<p>Related ticket(s):</p>
<ul class="simple">
<li><a class="reference external" href="http://www.freeipa.org/page/V4/User_Certificates#Certificate_Identity_Mapping">​http://www.freeipa.org/page/V4/User_Certificates#Certificate_Identity_Mapping</a></li>
</ul>
<div class="section" id="problem-statement">
<h2>Problem statement<a class="headerlink" href="#problem-statement" title="Permalink to this headline">¶</a></h2>
<div class="section" id="mapping">
<h3>Mapping<a class="headerlink" href="#mapping" title="Permalink to this headline">¶</a></h3>
<p>Currently it is required that a certificate used for authentication is
either stored in the LDAP user entry or in a matching override. This
might not always be applicable and other ways are needed to relate a
user with a certificate.</p>
</div>
<div class="section" id="matching">
<h3>Matching<a class="headerlink" href="#matching" title="Permalink to this headline">¶</a></h3>
<p>Even if SSSD will support multiple certificates on a Smartcard in the
context of
<a class="reference external" href="https://fedorahosted.org/sssd/ticket/3050">​https://fedorahosted.org/sssd/ticket/3050</a>
it might be necessary to restrict (or relax) the current certificate
selection in certain environments.</p>
</div>
</div>
<div class="section" id="use-cases">
<h2>Use cases<a class="headerlink" href="#use-cases" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id1">
<h3>Mapping<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>In some environments it might not be possible or would cause unwanted
effort to add certificates to the LDAP entry of the users to allow
Smartcard based authentication. Reasons might be:</p>
<ul class="simple">
<li><a class="reference external" href="https://docs.pagure.org/sssd-test2/Certificates/Smartcards.html">Certificates/Smartcards?</a>
are issued externally</li>
<li>LDAP schema extension is not possible or not allowed</li>
</ul>
</div>
<div class="section" id="id2">
<h3>Matching<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>A user might have multiple certificate on a Smartcard which are suitable
for authentication. But on some host in the environment only
certificates from a specific CA (while all other CAs are trusted as
well) or with some special extension should be valid for login.</p>
</div>
</div>
<div class="section" id="overview-of-the-solution">
<h2>Overview of the solution<a class="headerlink" href="#overview-of-the-solution" title="Permalink to this headline">¶</a></h2>
<p>To match a certificate a language/syntax has to be defined which allows
to reference items from the certificate and compare the values with the
expected data. To map the certificates to a user the language/syntax
should allow to relate certificate items with LDAP attributes so that
the value(s) from the certificate item can be used in a LDAP search
filter.</p>
</div>
<div class="section" id="implementation-details">
<h2>Implementation details<a class="headerlink" href="#implementation-details" title="Permalink to this headline">¶</a></h2>
<p>Since certificates form different CAs (i.e. a different issuer) might
have different properties and might be used in different domains mapping
rules cannot be applied unconditionally but only to &#8220;matching&#8221;
certificates. On the other hand it is not sufficient to know that a
certificate is valid for authentication if it cannot be determine which
users should be authenticated. This illustrates that mapping and
matching rules should be used together.</p>
<p>Besides the two rules there are two additional optional items to improve
mapping and matching. Mapping rules should be accompanied by a domain
list which contains a list of DNS domain names in which the user should
be searched. This will help to speed up searches and to avoid to leak
information to unrelated (but trusted) domains. In a complex environment
with many trusted domains a certificate might be assigned to any user.
And since it might be possible that the certificate is assigned to
multiple users searching cannot be stop after one matching user was
found. This means that without a domain list every single trusted domain
has to be checked. If the domain list a missing the default should be to
only search the local domain.</p>
<p>If certificates from many different issuers are used in an environment
might might be useful to have a matching rules which defines the minimal
requirements at a certificate. This rule will of courses not restrict
the issuer but will match all issuers. On the other hand there might be
issuers where the certificates needs special attention and more than the
minimal requirement are needed. To make sure that for this issuer there
is no fallback to the catch-all rules an extra issuer attribute would
make sure that for the given issuer only those rules will be applied and
there is no fallback to other rules.</p>
<p>As a result there four item which build certificate authentication rule,
the mapping and matching rule, a domain list and the issuer. All items
are optional. If there is no rule at all the current behavior is used as
default.</p>
<p>Coming use-case might require and extension of the current mapping and
matching rule or a completely different syntax is needed to cover a use
case. To make it possible to add new rule styles there should be a tag
prefix to indicate what style is expected to follow. For the tag I would
suggest a strings of upper-case ASCII characters (A(0x41)-Z(0x5a) and
numbers (0(0x30)-9(0x39) with a trailing colon (:(0x3a)). E.g. &#8216;KRB5:&#8217;,
&#8216;RFC4523:&#8217;, &#8216;LDAP:&#8217;.</p>
<p>SSSD will provide a library which will consume the rules to generate
LDAP search filters for its own usages to server matching users on
remote LDAP servers or in the local cache. Additionally it will provide
an interface to check if a given user object will match according to the
rules which can be use by the PKINIT matching plugin. To most suitable
representation for the user object (LDAPMessage, krb5_db_entry or
something else) must still be determined. To initialize the library a
list of LDAPMessage objects can be passed to an initialization function
which will return an opaque context.</p>
<div class="section" id="id3">
<h3>Matching<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>The pkinit plugin of MIT Kerberos must find a suitable certificate from
a Smartcard as well and has defined the following syntax (see the
pkinit_cert_match section of the krb5.conf man page or
<a class="reference external" href="http://web.mit.edu/Kerberos/krb5-1.14/doc/admin/conf_files/krb5_conf.html">​http://web.mit.edu/Kerberos/krb5-1.14/doc/admin/conf_files/krb5_conf.html</a>
for details). The main components are</p>
<ul class="simple">
<li>&lt;SUBJECT&gt;regular-expression</li>
<li>&lt;ISSUER&gt;regular-expression</li>
<li>&lt;SAN&gt;regular-expression</li>
<li>&lt;EKU&gt;extended-key-usage-list</li>
<li>&lt;KU&gt;key-usage-list</li>
</ul>
<p>and can be grouped together with a prefixed &#8216;&amp;&amp;&#8217; (and) or &#8216;<code class="docutils literal"><span class="pre">||</span></code>&#8216; (or)
operator (&#8216;&amp;&amp;&#8217; is the default). If multiple rules are given they are
iterated with the order in the config file as long as a rule matches
exactly one certificate.</p>
<p><strong>Question: MIT Kerberos use case-sensitive matching and POSIX Extended
Regular Expression syntax, shall we do the same?</strong></p>
<p>While &lt;SUBJECT&gt; and &lt;ISSUER&gt; are (imo) already quite flexible I can see
some potential extensions for the other components.</p>
<p>&lt;EKU&gt; and &lt;KU&gt; in MIT Kerberos only accept certain string values related
to some allowed values in those field as defined in
<a class="reference external" href="https://www.ietf.org/rfc/rfc3280.txt">​https://www.ietf.org/rfc/rfc3280.txt</a>
. The selection is basically determined by what is supported on server
side of the pkinit plugin of MIT Kerberos. Since we plan to extend
pkinit and support local authentication without pkinit as well I would
suggest to allow OID strings for those components as well (the
comparison is done on the OID level nonetheless).</p>
<p>The &lt;SAN&gt; component in MIT Kerberos only checks the otherName SAN
component for the id-pkinit-san OID as defined in
<a class="reference external" href="https://www.ietf.org/rfc/rfc4556.txt">​https://www.ietf.org/rfc/rfc4556.txt</a>
or the szOID_NT_PRINCIPAL_NAME OID as mentioned in
<a class="reference external" href="https://support.microsoft.com/en-us/kb/287547">​https://support.microsoft.com/en-us/kb/287547</a>.
While this is sufficient for the default pkinit user case of MIT
Kerberos I would suggest to extend this component by allowing to
specific an OID with &lt;SAN:O.I.D&gt;</p>
<p>The prefix tag for this type of matching rules would be &#8216;KRB5:&#8217; and I
would suggest to take this a default, i.e. if the prefix tag is missing
&#8216;KRB5:&#8217; will be assumed.</p>
</div>
<div class="section" id="matching-alternative-rfc4523-syntax">
<h3>Matching - alternative RFC4523 syntax<a class="headerlink" href="#matching-alternative-rfc4523-syntax" title="Permalink to this headline">¶</a></h3>
<p>Based on the X.509
<a class="reference external" href="https://docs.pagure.org/sssd-test2/CertificateAssertion.html">CertificateAssertion?</a>
syntax <a class="reference external" href="https://www.ietf.org/rfc/rfc4523.txt">​RFC4523</a> introduces
Generic String Encoding Rules (GSER)-based
(<a class="reference external" href="https://www.ietf.org/rfc/rfc3641.txt">​RFC3641</a> and
<a class="reference external" href="https://www.ietf.org/rfc/rfc3642.txt">​RFC3642</a>) syntax to write
<a class="reference external" href="https://docs.pagure.org/sssd-test2/CertificateAssertions.html">CertificateAssertions?</a>
which can be used to match certificates as well.</p>
<p>A matching rule for an issuer would look like</p>
<p>There is an identifier for keyUsage as well</p>
<p>but it looks like there is none specific for the extendedKeyUsage which
is important to separate certificate eg. for email signing and for login
purposes. I think even nameConstraints cannot be use here because
according to X.509 &#8220;nameConstraints matches if the subject names ...&#8221;
which only include the subject and the subject alternative names (please
let me know if there is a standardized way to add assertions for
extensions like the extendedKeyUsage).</p>
<p>Besides extendedKeyUsage there are other components in the certificate
where we want to add matching rules in the future which are currently
not handled by RFC4523. E.g. &#8216;Authority Information Access&#8217; (see
<a class="reference external" href="https://tools.ietf.org/rfc/rfc5280.txt">​RFC5280 section 4.2.2.1</a>
where information about CRLs or OCSP responders are stored. With this we
would be able to only select certificates which have an OCSP responder
defined or where we known that the CRL is updated regularly.</p>
<p>Although it would be possible to add new assertion for our usage
seamlessly I think it would not be a good idea to do this without making
sure that they will be added to any new versions of RFC4523. I currently
have no idea how easy or hard this would be and how this would limit our
flexibility to react on request from users and customers.</p>
<p>To restrict the matching not only to a single certificate but to a group
of certificates based on the subject (owner) name constraints as defined
in <a class="reference external" href="https://tools.ietf.org/html/rfc3280.html#section-4.2.1.11">​RFC3280 section
4.2.1.11</a>
can be used. The constraints are applied to the subject name and subject
alternative names attributes in the certificate and consist of a list of
allowed names (permittedSubtrees) and rejected names (excludedSubtrees).
For directory names (the subject name and the related SAN attribute) an
area in the directory tree can be specified where the names should
match. E.g. to match all subject names from the &#8216;research&#8217; department
but not from sub-departments of &#8216;research&#8217;</p>
<p>can be used. To allow everything but the &#8216;no_access&#8217; subtree</p>
<p>can be used, &#8216;minimum&#8217; and &#8216;maximum&#8217; are not needed here because the
default for &#8216;minimum&#8217; is &#8216;0&#8217; and a missing &#8216;maximum&#8217; specifies the whole
subtree.</p>
<p>Compared the regular-expressions this syntax makes it easy to reject
specific types of names. But it also requires that a full base is
specified and only a simple &#8216;*key_string*&#8217;. This is of course more
safe but it has to be noted that the matching rules are only applied on
valid and verified certificates. Since CA certificates can contain name
constraints as well and <a class="reference external" href="http://nmav.gnutls.org/2016/06/restricting-scope-of-ca-certificates.html">​with p11-kit it is even possible to staple
those
extensions</a>
it would be possible to reject certificates system-wide already during
the verification.</p>
<p>Based on this I would suggest to reserve the prefix tag &#8216;RFC4523:&#8217; for
this type of matching rule but postpone the implementation.</p>
<div class="section" id="issuer-specific-matching">
<h4>Issuer specific matching<a class="headerlink" href="#issuer-specific-matching" title="Permalink to this headline">¶</a></h4>
<p>Although the MIT Kerberos rules allow to select the issuer of a
certificate there are use cases where a more specific selection is
needed. E.g. if there are some default matching rules for all issuers
and some other issuer specific rules where the default rules should not
apply. To make this possible with the above scheme the default rules
must have an &lt;ISSUER&gt; clause which matches all but the issuer with the
specific rules. Writing regular-expressions to not match a specific
string or a list of strings is at least error-prone if not impossible.</p>
<p>To make it easier to define issuer specific rules and default rules at
the same time and optional issuer string can be added to the rule to
indicate that for the given issuer only those rules should be
considered. Given the use-case I think it is acceptable to require that
the full issuer must be specified here in LDAP order (see below) and
case-sensitive matching is used.</p>
<p>How the issuer string is linked to the matching rules depends on the
storage (LDAP or sssd.conf, see below for details).</p>
</div>
</div>
<div class="section" id="id4">
<h3>Mapping<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>Since different certificates, e.g. issued by different CAs, might have
different mapping rule, a matching rule must be added if there are more
than 1 mapping rule. A single mapping rule without a matching rule might
be used as default/catch-all rule in this case.</p>
<p>If multiple rules matches the derived LDAP filter components can be
grouped with the or-operator &#8220;|&#8221;.</p>
<p>With trusted AD forests the mapped users might come from trusted domains
as well. To avoid searching in every single domain a list of expected
domains can be added to each mapping rule. If the list is empty the
local domain is assumed by default. An option might be added to switch
the behavior to search all domains if the list is empty.</p>
<p>Similar to Active Directory we will require a dedicated LDAP attribute
in the user entry (anchor) to map the certificate to the user entry.
Mapping rules which allow to search users based on some data from the
certificate and common LDAP attributes make it easy to roll out
certificate based authentication in existing environments. E.g. if one
of the SAN attributes in the certificate contains the email address of
the user a single mapping rule is needed to map every user with a
certificate. No changes to existing LDAP user objects are needed.</p>
<p>On the other hand certificates issues by external CA might not contain
data to reliable match all users based on common LDAP attributes. Or it
should be possible to authenticate with a single certificate as multiple
different users. In those cases a dedicated attributes is needed in the
user entry which contains some information about the certificate like
the altSecurityIdentities attribute used by Active Directory.</p>
<p>A specific per-user attribute also relates to other authentication
methods available for a users. Password hashes and Kerberos keys are
stored in the user entry as well. OTP tokens are managed in separate
objects but contain the DN of the user as a unique reference. In all
cases the removal of a single attribute will disable/remove a specific
authentication method for a user.</p>
<p>Finally, since mapping is about searching a user entry in the LDAP tree
the dedicated attribute can be indexed to speed up the searches and help
to avoid a high server load.</p>
<div class="section" id="compatibility-with-active-directory">
<h4>Compatibility with Active Directory<a class="headerlink" href="#compatibility-with-active-directory" title="Permalink to this headline">¶</a></h4>
<p>With trusted AD forests we have to support the mapping anchors used by
AD which is typically an issue-subject pair like e.g.
<em>X509:&lt;I&gt;C=US,O=InternetCA,CN=APublicCertificateAuthority&lt;S&gt;C=US,O=Fabrikam,OU=Sales,CN=Jeff
Smith</em>. Active Directory uses a per-user LDAP attribute
<a class="reference external" href="https://msdn.microsoft.com/en-us/library/cc220106.aspx">​altSecurityIdentities</a>
to allow arbitrary user-certificate mappings if there is no suitable
user-principal-name entry in the SAN of the certificate or if a single
certificate should be used to authenticate as different users.</p>
<p>Unfortunately there is no single document where all values and use-case
of this attribute are listed. The best overview I found is in
<a class="reference external" href="https://blogs.msdn.microsoft.com/spatdsg/2010/06/18/howto-map-a-user-to-a-certificate-via-all-the-methods-available-in-the-altsecurityidentities-attribute/">​https://blogs.msdn.microsoft.com/spatdsg/2010/06/18/howto-map-a-user-to-a-certificate-via-all-the-methods-available-in-the-altsecurityidentities-attribute/</a>.
In
<a class="reference external" href="https://msdn.microsoft.com/en-us/library/ms677943%28v=vs.85%29.aspx">​https://msdn.microsoft.com/en-us/library/ms677943%28v=vs.85%29.aspx</a>
it is explained how altSecurityIdentities is used for user object and
only mentions the issue-subject pair as an example, but does not mention
other cases.
<a class="reference external" href="https://msdn.microsoft.com/en-us/library/hh536384.aspx">​https://msdn.microsoft.com/en-us/library/hh536384.aspx</a>
explains what is required for PKINIT which includes the issuer-subject
pair but allows 5 other variants as well. (Interestingly, the user
related page says that using only the issuer &lt;I&gt; is allowed but not
using only the subject &lt;S&gt; while the PKINIT page says that using only
the subject &lt;S&gt; is allowed and does not list a usage with only the issue
&lt;I&gt;. I guess it is a typo in the user page, because &lt;S&gt; contains user
specific information while &lt;I&gt; is the same for all certificates from the
given issuer).</p>
<p>So it looks like the most important variant is the issuer-subject pair.
This one is e.g. created when a certificate is added via the &#8216;Name
Mappings&#8217; context menu entry in AD&#8217;s &#8216;Users and Computers&#8217; utility
(&#8216;Advanced Features&#8217; must be activated in the &#8216;View&#8217; menu). The
attribute value might look like</p>
<p>First it can be seen that X.500 ordering is used. Second, if RDN types
not explicitly mentioned in the RFCs are used, you are on your own. As
can be seen AD can translate the deprecated OID
<a class="reference external" href="http://www.oid-info.com/get/1.2.840.113549.1.9.1">​1.2.840.113549.1.9.1</a>
and uses &#8216;E&#8217; as NSS. But the OID
<a class="reference external" href="http://www.oid-info.com/get/0.9.2342.19200300.100.1.1">​0.9.2342.19200300.100.1.1</a>
which is explicitly mentioned in RFC4514 is not translated as UID but
the plain OID syntax is used (my guess it that Microsoft tries to be
compatible with &#8220;older&#8221; versions because the UID was added in RFC2253
from 1997 but was not present in the RFC1779 from 1995 and RFC1485 from
1993).</p>
<p>This leads us to mapping rules like &lt;ALT-SEC-ID-I-S:ldapAttributeName&gt;
which would try in a best effort to produce the exact attribute value AD
is using. This should work reliable with standard RDN types (see above).
I think an optional &#8216;ldapAttributeName&#8217; is useful here so that the same
mapping rule can be used with different LDAP servers (e.g. IPA) where
user-specific mapping attributes are used with the same content but a
different attribute name.</p>
<p>According to the blob post describing altSecurityIdentities some other
additional mapping rules might be useful too. This will give us</p>
<ul class="simple">
<li>&lt;ALT-SEC-ID-I-S:ldapAttributeName&gt;</li>
<li>&lt;ALT-SEC-ID-S:ldapAttributeName&gt;</li>
<li>&lt;ALT-SEC-ID-SKI:ldapAttributeName&gt;</li>
<li>&lt;ALT-SEC-ID-I-SR:ldapAttributeName&gt;</li>
<li>&lt;ALT-SEC-ID-SHA1-PUBKEY:ldapAttributeName&gt;</li>
<li>&lt;ALT-SEC-ID-RFC822:ldapAttributeName&gt;</li>
<li>&lt;ALT-SEC-ID-TP-PUBKEY:ldapAttribute&gt; (?)</li>
</ul>
<p>(The last is mentioned in <a class="reference external" href="https://msdn.microsoft.com/en-us/library/dn408946.aspx">​MS-DVRE section
2.3.3.</a> but
seems to be specific for joining devices in Azure)</p>
<p>So far I didn&#8217;t found a AD tool which creates to other mappings, if you
know one, please let me know.</p>
<p>Besides altSecurityIdentities AD uses the SAN with the
szOID_NT_PRINCIPAL_NAME OID to map users. It has to be noted that AD
does not only look at the &#8216;userPrincipalName&#8217; LDAP attribute to map the
principal from the certificate but uses the default principal of an AD
user <a class="reference external" href="mailto:'samAccountName&#37;&#52;&#48;AD&#46;REALM">​'samAccountName<span>&#64;</span>AD<span>&#46;</span>REALM</a>&#8216; as
well. Interestingly a &#8216;Kerberos:user&#64;AD.REALM&#8217; entry in
altSecurityIdentities did not work in my tests and AD denied login. So
what AD does currently matches how SSSD tried to resolve a
fully-qualified name against AD. I would suggest a mapping rule like</p>
<ul class="simple">
<li>&lt;NT_PRINCIPAL_NAME:ldapAttributeName&gt;</li>
</ul>
<p>to allow the search the user with the SAN value. When the backend is
talking to AD and the principal cannot be found the fallback search with
the &#8216;samAccountName&#8217; LDAP is used. Since <a class="reference external" href="https://msdn.microsoft.com/en-us/library/cc238488.aspx">​MS-PKCS Appendix
A</a> explicitly
says that id-pkinit-san is ignored it does not have to be included for
this mapping rule.</p>
</div>
<div class="section" id="using-the-certificate-as-an-anchor">
<h4>Using the Certificate as an anchor<a class="headerlink" href="#using-the-certificate-as-an-anchor" title="Permalink to this headline">¶</a></h4>
<p>For IPA and other generic LDAP servers an LDAP attribute like e.g.
userCertificate is a good anchor as well and is currently already used
to allow local authentication with a Smartcard. Since it is the current
default I would suggest that an empty mapping rule with use the LDAP
attribute configured by the SSSD option ldap_user_certificate as
anchor and search with the whole certificate.</p>
<p>It has to be noted that having the binary certificate in the
userCertificate LDAP attribute is not sufficient for pkinit on AD.
Either checks in the matching rule, e.g. checking if a SAN with
szOID_NT_PRINCIPAL_NAME OID is available, or mapping rules from above
should be used if pkinit is required with AD.</p>
</div>
<div class="section" id="future-consideration">
<h4>Future consideration<a class="headerlink" href="#future-consideration" title="Permalink to this headline">¶</a></h4>
<p>A mapping rule can use a similar syntax like the matching rule where the
LDAP attribute can be added with a &#8216;:&#8217;, e.g.</p>
<ul class="simple">
<li>&lt;ISSUER:O.I.D.:ldapAttributeName:*&gt;</li>
<li>&lt;SUBJECT:O.I.D.:ldapAttributeName:*&gt;</li>
<li>&lt;SAN:O.I.D.:ldapAttributeName:*&gt;</li>
</ul>
<p>where O.I.D. is either the OID or name of a RDN type or the OID or some
well-known-name of the SAN component respectively. Since the SUBJECT
might contain multiple RDNs of the same type always the &#8220;most specific&#8221;
is selected because in general this will be the most suited one to map
the certificate to a specific user. &#8220;most specific&#8221; means the last in
X.500 order and the first in LDAP order (see discussion below for
details).</p>
<p>If the O.I.D. is missing the full SUBJECT/ISSUER is used for mapping. If
&#8216;DN&#8217; is used as ldapAttributeName SUBJECT is expected to be the DN of
the user. If the O.I.D. is missing in the SAN case the same default as
with matching (id-pkinit-san and szOID_NT_PRINCIPAL_NAME OID) is
used. If both SAN values can be found in the certificate and are
different the LDAP search filter will combine both with the or-operator.</p>
<p>The optional &#8216;*&#8217; in the end indicates that a sub-string search
(ldapAttributeName=*value*) should be used and not an exact match
(ldapAttributeName=value). Please note that it depends on the
server-side definition of the LDAP attribute if case-sensitive or
case-insensitve matching is used.</p>
<p>Currently I see no usage for &lt;KU&gt; and &lt;EKU&gt; in mapping rules because
they do not contain any user-specific data. If at some point we will
have personal CAs we might consider to add &lt;ISSUER&gt; based mappings.</p>
<p>Most of the interesting values from the SAN should be directly map-able
to LDAP attributes. And processing the string representation of
&lt;SUBJECT&gt; might be tricky as discussed below. Nevertheless it might be
possible to add to following in a future release if more complex
operations on the values are needed:</p>
<ul class="simple">
<li>&lt;SUBJECT:ldapAttributeName&gt;/regexp/replacement/</li>
<li>&lt;SAN:O.I.D.:ldapAttributeName&gt;/regexp/replacement/</li>
</ul>
<p>where &#8220;/regexp/replacement/&#8221; stands for optional sed-like substitution
rules. E.g. a rule like</p>
<p>would take the subject string &#8216;CN=Certuser,CN=Users,DC=example,DC=com&#8217;
from the certificate and generate a LDAP search filter component
&#8216;(samAccountName=Certuser)&#8217; which can be included in a LDAP search
filter which includes additional components like e.g. an objectClass.</p>
<p>The search-and-replace does not has to be sed-like because afaik there
is not library which offers this and I would like to avoid implementing
it. GLib e.g. has
<a class="reference external" href="https://developer.gnome.org/glib/stable/glib-Perl-compatible-regular-expressions.html#g-regex-replace">​g_regex_replace</a>.
Since we already have a GLib dependency in SSSD due to soem utf8 helper
functions using might be acceptable as well. Nevertheless it would be
nice to hear if there are alternative libraries available as well.</p>
<p>Maybe even search-and-replace are not sufficient for all cases and
something like embedded lua scripts are needed. But since certificate
mapping is about access control and authorization it should be always
considered if adding a new attribute to the users LDAP entry which makes
mapping easy and straight-forward wouldn&#8217;t be the better solution.</p>
</div>
<div class="section" id="some-notes-about-dns">
<h4>Some notes about DNs<a class="headerlink" href="#some-notes-about-dns" title="Permalink to this headline">¶</a></h4>
<p>The X.500 family of standards define names as &#8220;SEQUENCE OF
<a class="reference external" href="https://docs.pagure.org/sssd-test2/RelativeDistinguishedName.html">RelativeDistinguishedName?</a>&#8221;
where the sequence is &#8220;starting with the root and ending with the object
being named&#8221; (see X.501 section 9.2 for details). On the other hand
RFC4514 section 2.1 says &#8220;Otherwise, the output consists of the string
encoding of each
<a class="reference external" href="https://docs.pagure.org/sssd-test2/RelativeDistinguishedName.html">RelativeDistinguishedName?</a>
in the RDNSequence (according to Section 2.2), starting with the last
element of the sequence and moving backwards toward the first.&#8221; This
means that the ASN.1 encoded issuer and subject DN from the X.509
certificate can be either displayed as string in the</p>
<ul class="simple">
<li>X.500 order: DC=com,DC=example,CN=users,CN=Certuser</li>
</ul>
<p>or in the</p>
<ul class="simple">
<li>LDAP order: CN=Certuser,CN=Users,DC=example,DC=com</li>
</ul>
<p>As a consequence different tools will use a different order when
printing the issuer and subject DN. While NSS&#8217;s certutil will use the
LDAP order, &#8216;openssl x509&#8217; and gnutls&#8217;s certtool will use the X.500
order (the latter might change due to
<a class="reference external" href="https://gitlab.com/gnutls/gnutls/issues/111">​https://gitlab.com/gnutls/gnutls/issues/111</a>).</p>
<p>This makes it important to specific the order which is used by SSSD for
mapping and matching. I would prefer the LDAP order here. E.g. by
default the AD CA uses the DN of the users entry in AD as subject in the
issues certificate. So a matching rule like &#8216;&lt;SUBJECT:dn&gt;&#8217; could tell
SSSD to directly search the user based on its DN (which btw is the
original intention of the subject field in the certificate, only that
the DN should be looked up in a more general DAP as defined by X.500 and
not in the lightweight version called LDAP)</p>
<p>Another issue is the limited set of attribute names/types required by
the RFCs (see section 4.1.2.4 of RFC 3280 and section 3 of RFC 4514). If
e.g. the deprecated OID
<a class="reference external" href="http://www.oid-info.com/get/1.2.840.113549.1.9.1">​1.2.840.113549.1.9.1</a>
is used all tools are able to identify it as an email address but
OpenSSL displays it as
&#8216;emailAddress=`​user&#64;example.com &lt;<a class="reference external" href="mailto:user&#37;&#52;&#48;example&#46;com">mailto:user<span>&#64;</span>example<span>&#46;</span>com</a>&gt;`__&#8217;, certtool
as &#8216;EMAIL=`​user&#64;example.com &lt;<a class="reference external" href="mailto:user&#37;&#52;&#48;example&#46;com">mailto:user<span>&#64;</span>example<span>&#46;</span>com</a>&gt;`__&#8217; and certutil
as &#8216;E=`​user&#64;example.com &lt;<a class="reference external" href="mailto:user&#37;&#52;&#48;example&#46;com">mailto:user<span>&#64;</span>example<span>&#46;</span>com</a>&gt;`__&#8217;. So matching
rules should try to avoid attribute names or only the ones from <a class="reference external" href="https://www.ietf.org/rfc/rfc4514.txt">​RFC
4514</a>:</p>
<ul class="simple">
<li>CN commonName (2.5.4.3)</li>
<li>L localityName (2.5.4.7)</li>
<li>ST stateOrProvinceName (2.5.4.8)</li>
<li>O organizationName (2.5.4.10)</li>
<li>OU organizationalUnitName (2.5.4.11)</li>
<li>C countryName (2.5.4.6)</li>
<li>STREET streetAddress (2.5.4.9)</li>
<li>DC domainComponent (0.9.2342.19200300.100.1.25)</li>
<li>UID userId (0.9.2342.19200300.100.1.1)</li>
</ul>
</div>
</div>
<div class="section" id="about-restricting-or-enforcing-the-mapping-an-matching-any-further">
<h3>About restricting or enforcing the mapping an matching any further<a class="headerlink" href="#about-restricting-or-enforcing-the-mapping-an-matching-any-further" title="Permalink to this headline">¶</a></h3>
<p>The goal of the matching rules in MIT Kerberos is to select a single
certificate from a Smartcard which will then be used for PKINIT. Since
we already plan to enhance SSSD to support multiple certificates on a
Smartcard and if needed prompt the user which one to use for login we
should not enforce that the matching rules should return only a single
certificate or nothing.</p>
<p>Similar we plan to enhance SSSD to use the same certificate to log in
with different user identities, e.g. as a user with standard privileges
or as a user with administrator privileges. So it can make sense that
multiple mapping rules apply to the same certificate and the related
LDAP search filter components are or-ed together.</p>
<p>In many cases the login program will first ask for a user name which
will help to restrict the number of suitable certificates even further
and the mapping rules are only needed to check if the certificate
belongs to the user trying to log in.</p>
<p>But gdm has a feature where gdm will detect when a Smartcard is inserted
and call PAM without a user name. In this case SSSD has to determine the
user name based on the certificates found on the Smartcard. If in this
case multiple valid certificates are on the card and the mapping rules
will return multiple users for each certificate gdm has to display a
quite long selection of certificate-user pairs the user has to choose
from.</p>
<p>So it should be underlined in the documentation that the matching and
mapping rules should be detailed and specific so that for the given
environment they help to avoid cases where the user is prompted to
select a certificate (or user name in the gdm case) when trying to log
in.</p>
</div>
<div class="section" id="storing-matching-and-mapping-configuration">
<h3>Storing matching and mapping configuration<a class="headerlink" href="#storing-matching-and-mapping-configuration" title="Permalink to this headline">¶</a></h3>
<p>On the IPA server a new objectclass can be created to store an
matching-mapping-domain rule triple together with a specific issuer. All
attributes are optional because a missing mapping rule would mean that
the user entry will be search with the whole certificate. A missing
matching rule will indicate catch-all rule with a default mapping. If
the domain is missing only the local domain will be searched. If only a
specific issuer is given certificates from this issuer must be stored in
the LDAP entry of the user for the local domain to make authentication
possible.</p>
<p>Specifying matching-mapping-domain rules in sssd.conf is a bit more
complicated because SSSD does not respect multiple entries with the same
keyword, only the last one is used. So all rules have to be added to a
single line. To make this less error-prone and more readable the rules
with all needed components can a added in individual ini-sections and in
the domain section on the the name is referenced</p>
<p>As an alternative the rules components can be enclosed by curly-braces
&#8216;{}{}{}{}&#8217; and each rule is separated by a comma &#8216;,&#8217;. A single rule in
curly braces indicates a matching rule and the mapping will be done with
the whole certificate. A default/catch-all mapping rule will start with
an empty pair of curly braces followed by a pair containing the mapping
rule. Issuer specific rules will have three pairs of curly braces where
the first pair must contain an issuer string.</p>
<div class="section" id="examples">
<h4>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">Only matching rule</p>
<p>only allow certificates with have the Microsoft OID for Smartcard
logon 1.3.6.1.4.1.311.20.2.2 set, use the whole certificate to
look-up the user in the local domain. The same result can be achieved
with</p>
</li>
<li><p class="first">Matching rule with OID:</p>
<p>see above</p>
</li>
<li><p class="first">e</p>
<p>only allow certificates form the &#8216;my-company&#8217; issuer which have an
email address from the &#8216;my-company.com&#8217; domain in the rfc882Name SAN
attribute. Use AD style issuer-subject search filter
&#8216;(altSecurityIdentities=&lt;I&gt;cn=issuer,dc=my-company,dc=com&lt;S&gt;cn=user,dc=my-company,dc=com)&#8217;
to find the matching user in the</p>
</li>
</ul>
<p>domain &#8216;my-company.com&#8217;</p>
</div>
</div>
<div class="section" id="mapping-alternative-direct-use-of-ldap-search-filters">
<h3>Mapping - alternative direct use of LDAP search filters<a class="headerlink" href="#mapping-alternative-direct-use-of-ldap-search-filters" title="Permalink to this headline">¶</a></h3>
<p>Since the goal of the mapping rules is to create a LDAP search filter a
filter template can be used to define a mapping rules a well:</p>
<p>This offers much more flexibility in the rules. The syntax is a bit more
complex but LDAP search filters are well documented and administrators
should already have a basic understanding. Nevertheless a validation is
needed when a new rule is entered to make sure the template can be use
to generate a valid LDAP search filter.</p>
</div>
</div>
<div class="section" id="configuration-changes">
<h2>Configuration changes<a class="headerlink" href="#configuration-changes" title="Permalink to this headline">¶</a></h2>
<p>Does your feature involve changes to configuration, like new options or
options changing values? Summarize them here. There&#8217;s no need to go into
too many details, that&#8217;s what man pages are for.</p>
</div>
<div class="section" id="how-to-test">
<h2>How To Test<a class="headerlink" href="#how-to-test" title="Permalink to this headline">¶</a></h2>
<p>This section should explain to a person with admin-level of SSSD
understanding how this change affects run time behaviour of SSSD and how
can an SSSD user test this change. If the feature is internal-only,
please list what areas of SSSD are affected so that testers know where
to focus.</p>
</div>
<div class="section" id="how-to-debug">
<h2>How To Debug<a class="headerlink" href="#how-to-debug" title="Permalink to this headline">¶</a></h2>
<p>Explain how to debug this feature if something goes wrong. This section
might include examples of additional commands the user might run (such
as keytab or certificate sanity checks) or explain what message to look
for.</p>
</div>
<div class="section" id="authors">
<h2>Authors<a class="headerlink" href="#authors" title="Permalink to this headline">¶</a></h2>
<p>Give credit to authors of the design in this section.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Matching and Mapping Certificates</a><ul>
<li><a class="reference internal" href="#problem-statement">Problem statement</a><ul>
<li><a class="reference internal" href="#mapping">Mapping</a></li>
<li><a class="reference internal" href="#matching">Matching</a></li>
</ul>
</li>
<li><a class="reference internal" href="#use-cases">Use cases</a><ul>
<li><a class="reference internal" href="#id1">Mapping</a></li>
<li><a class="reference internal" href="#id2">Matching</a></li>
</ul>
</li>
<li><a class="reference internal" href="#overview-of-the-solution">Overview of the solution</a></li>
<li><a class="reference internal" href="#implementation-details">Implementation details</a><ul>
<li><a class="reference internal" href="#id3">Matching</a></li>
<li><a class="reference internal" href="#matching-alternative-rfc4523-syntax">Matching - alternative RFC4523 syntax</a><ul>
<li><a class="reference internal" href="#issuer-specific-matching">Issuer specific matching</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id4">Mapping</a><ul>
<li><a class="reference internal" href="#compatibility-with-active-directory">Compatibility with Active Directory</a></li>
<li><a class="reference internal" href="#using-the-certificate-as-an-anchor">Using the Certificate as an anchor</a></li>
<li><a class="reference internal" href="#future-consideration">Future consideration</a></li>
<li><a class="reference internal" href="#some-notes-about-dns">Some notes about DNs</a></li>
</ul>
</li>
<li><a class="reference internal" href="#about-restricting-or-enforcing-the-mapping-an-matching-any-further">About restricting or enforcing the mapping an matching any further</a></li>
<li><a class="reference internal" href="#storing-matching-and-mapping-configuration">Storing matching and mapping configuration</a><ul>
<li><a class="reference internal" href="#examples">Examples</a></li>
</ul>
</li>
<li><a class="reference internal" href="#mapping-alternative-direct-use-of-ldap-search-filters">Mapping - alternative direct use of LDAP search filters</a></li>
</ul>
</li>
<li><a class="reference internal" href="#configuration-changes">Configuration changes</a></li>
<li><a class="reference internal" href="#how-to-test">How To Test</a></li>
<li><a class="reference internal" href="#how-to-debug">How To Debug</a></li>
<li><a class="reference internal" href="#authors">Authors</a></li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/DesignDocs/MatchingAndMappingCertificates.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="nav-item nav-item-0"><a href="../index.html">sssd 1.15.1 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Red Hat.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.2.
    </div>
  </body>
</html>