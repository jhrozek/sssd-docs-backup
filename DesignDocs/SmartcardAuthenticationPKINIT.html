<html><head><link rel="stylesheet" href="/sssd-test2/trac.css" type="text/css" /><link rel="stylesheet" href="/sssd-test2/wiki.css" type="text/css" /></head><body><h1 id="SmartcardAuthentication-PKINIT">Smartcard Authentication - PKINIT</h1>
<p>
Related ticket(s):
</p>
<ul><li><a class="ext-link" href="https://fedorahosted.org/sssd/ticket/3270"><span class="icon">â€‹</span>https://fedorahosted.org/sssd/ticket/3270</a>
</li></ul><h3 id="Problemstatement">Problem statement</h3>
<p>
Currently Smartcard Authentication is only used to authenticate against the local system. PKINIT would provide a method to use Kerberos for authentication and get a Kerberos Ticket Granting Ticket (TGT) during the authentication so that network resources can be accessed with Kerberos/GSSAPI. 
</p>
<h3 id="Usecases">Use cases</h3>
<p>
Client systems which joined to Kerberos based domains like Active Directory (AD) or FreeIPA can use Smartcard authentication to replace password based authentication and still get full single-sign-on (SSO) access to the resources of the domain.
</p>
<h3 id="Overviewofthesolution">Overview of the solution</h3>
<p>
SSSD's KRB5 provider will detect the presence of the PKINIT pre-authentication method using the responder interface of recent MIT Kerberos version. This is similar to the current detection of password authentication (single-factor authentication, 1FA) and two-factor authentication (2FA). Based on the available pre-authentication methods and if a Smartcard with a suitable certificate is currently accessible by SSSD the user will be prompted differently about what credentials should be entered for authentication.
</p>
<table class="wiki">
<tr><td style="text-align: left">Available pre-authentication types </td><td> suitable Smartcard present </td><td> User prompting 
</td></tr><tr><td> pkinit </td><td> no </td><td> Ask to insert Smartcard and enter PIN 
</td></tr><tr><td> pkinit </td><td> yes </td><td> Ask for PIN 
</td></tr><tr><td> 1FA, pkinit </td><td> no </td><td> Ask for password 
</td></tr><tr><td> 1FA, pkinit </td><td> yes </td><td> Ask for PIN, fallback to password if no PIN is given 
</td></tr><tr><td> 2FA, pkinit </td><td> no </td><td> Ask for first and second factor 
</td></tr><tr><td> 2FA, pkinit </td><td> yes </td><td> Ask for PIN, fallback to first and second factor if no PIN is given 
</td></tr><tr><td> 1FA, 2FA, pkinit </td><td> no </td><td> Ask for first and optional second factor 
</td></tr><tr><td> 1FA, 2FA, pkinit </td><td> yes </td><td> Ask for PIN, fallback to first and optional second factor if no PIN is given 
</td></tr><tr><td> 1FA </td><td> no </td><td> Ask for password 
</td></tr><tr><td> 1FA </td><td> yes </td><td> Ask for PIN (for local authentication), fallback to password if no PIN is given 
</td></tr><tr><td> 2FA </td><td> no </td><td> Ask for first and second factor 
</td></tr><tr><td> 2FA </td><td> yes </td><td> Ask for PIN (for local authentication), fallback to first and second factor if no PIN is given 
</td></tr><tr><td> 1FA, 2FA </td><td> no </td><td> Ask for first and optional second factor 
</td></tr><tr><td> 1FA, 2FA </td><td> yes </td><td> Ask for PIN (for local authentication), fallback to first and optional second factor if no PIN is given 
</td></tr></table>
<p>
Ideally the prompting will be configurable so that it can be adopted for other non-IPA/non-AD use cases but the primary goal is to have sensible defaults which work well for IPA and AD.
</p>
<h3 id="Implementationdetails">Implementation details</h3>
<p>
The responder interface indicates the availability of PKINIT if there is KRB5_RESPONDER_QUESTION_PKINIT in the krb5_responder_question_list(). During the SSSD pre-auth run this can be used to signal the availability to the client. During authentication it should be used to set the answer if the Smartcard authentication credentials including the PIN and other details are available.
</p>
<p>
Since it is possible that there are multiple certificates on the Smartcard and even that multiple Smartcards are accessible at the same time the MIT Kerberos PKINIT plugin must be called in a way to make sure that only the right certificate is used. The right certificate here is the one that was previously selected either by SSSD's PAM responder or the user.
</p>
<p>
To select a certificate MIT Kerberos provides the "X509_user_identity" option which can be set with krb5_get_init_creds_opt_set_pa(). This is the same option which can be set with the -X option of the kinit command. For PKCS<a class="closed ticket" href="https://fedorahosted.org/sssd/ticket/11" title="defect: Implement auto-reconnection of the PAM Responder to the Data Provider (closed: fixed)">#11</a> the syntax of the identify string is
</p>
<pre class="wiki">PKCS11:[module_name=]modname[:slotid=slot-id][:token=token-label][:certid=cert-id][:certlabel=cert-label]
</pre><p>
From the krb5.conf man page: "All  keyword/values  are  optional. modname specifies the location of a library implementing PKCS<a class="closed ticket" href="https://fedorahosted.org/sssd/ticket/11" title="defect: Implement auto-reconnection of the PAM Responder to the Data Provider (closed: fixed)">#11</a>. If a value is encountered with no keyword, it is assumed to be the modname. If no module-name is specified, the default is opensc-pkcs11.so.  slotid= and/or token= may be specified to force the use of a particular smard card reader or token if there is more than one available. certid= and/or certlabel= may be specified to force the selection of a particular certificate on the device. See the pkinit_cert_match configuration option for more ways to select a particular certificate to use for PKINIT."
</p>
<p>
Sending the 'modname', 'token-label' and 'certid' would be sufficient to select the certificate on the PKCS<a class="closed ticket" href="https://fedorahosted.org/sssd/ticket/11" title="defect: Implement auto-reconnection of the PAM Responder to the Data Provider (closed: fixed)">#11</a> level. But unfortunate this does not contain any detail of the certificate itself. It is recommended that 'certid' which maps to CKA_ID PKCS<a class="closed ticket" href="https://fedorahosted.org/sssd/ticket/11" title="defect: Implement auto-reconnection of the PAM Responder to the Data Provider (closed: fixed)">#11</a> attribute is the SHA1 value of the modulus of the RSA key but this is not enforced at any place. To make sure that the PKINIT plugin really users the certificate we expect it to use pkinit_cert_match must be used. Unfortunately there is no direct library call to set it the plugin will read it directly from the profile of the krb5_context. This means that SSSD must modify the profile can create a new krb5_context with krb5_init_context_profile(). While looking for a value for pkinit_cert_match the PKINIT plugin first checks if the option can be found a realm sub-section in the [libdefaults] section where the realm must match the realm of the client principal, i.e. the principal which tries to authenticate.
</p>
<p>
As matching string "&lt;ISSUER&gt;certificateIssuer&lt;SUBJECT&gt;certificateSubject" can be used. Although there is a NSS implementation for the PKINIT plugin available in the MIT Kerberos source code it is neither used in recent Fedora or RHEL versions but the OpenSSL implementation is used. To avoid when translating the ASN.1 representation of the issuer and subject from the certificate to a DN string krb5_child should use OpenSSL unconditionally for this translation independent of the setting of the '--with-crypto' configure option.
</p>
<p>
With "X509_user_identity" and "pkinit_cert_match" set the available choices for the PKINIT plugin should be sufficiently restricted so that not accidentally a wrong certificate is selected. It should even prevent the scenario where an attacker replaces the Smartcard between mapping the Smartcard to a system user and doing the PKINIT based authentication.
</p>
<h3 id="Configurationchanges">Configuration changes</h3>
<h4 id="etckrb5.conf">/etc/krb5.conf</h4>
<p>
Besides 'pkinit_anchor' there are two krb5.conf options which might need to be set on the client to make PKINIT work, 'pkinit_eku_checking' and 'pkinit_kdc_hostname'.
</p>
<p>
By default the PKINIT plugin of MIT Kerberos expects that the KDC certificate contains the id-pkinit-KPKdc EKU as defined in RFC 4556 and has the kdc's hostname in id-pkinit-san as defined in RFC4556 as well.
</p>
<p>
If id-pkinit-san is missing 'pkinit_kdc_hostname' can be set to the hostname of the kdc as stored in the dNSName in the SAN of the certificate. If the dNSName SAN is missing as well, PKINIT won't work.
</p>
<p>
If the id-pkinit-KPKdc EKU is not set 'pkinit_eku_checking' can be set to 'kpServerAuth' is the certificate of the kdc at least contains the id-kp-serverAuth EKU. If this is missing as well 'pkinit_eku_checking' can be set to 'none', but this is not recommended.
</p>
<p>
See the krb5.conf man page for details about the options.
</p>
<p>
In theory it would be possible that SSSD sets this options automatically to make PKINIT work without adding options to krb5.conf manually. One way would be to inspect the certificate presented by the KDC and set to options according to the certificate content. But since SSSD does not have any knowledge what content would be expected it might unknowingly lower the security by receiving a spoofed ticket. It would be possible to add now options for SSSD but then it would be more easy to add the options directly to /etc/krb5.conf. With the recently introduced /etc/krb5.conf.d/ drop-in directory for config snippets a suitable snippets must be only created once and added to /etc/krb5.conf.d/ on the clients.
</p>
<h3 id="HowToTest">How To Test</h3>
<p>
This section should explain to a person with admin-level of SSSD understanding how this change affects run time behaviour of SSSD and how can an SSSD user test this change. If the feature is internal-only, please list what areas of SSSD are affected so that testers know where to focus.
</p>
<h3 id="HowToDebug">How To Debug</h3>
<p>
Explain how to debug this feature if something goes wrong. This section might include examples of additional commands the user might run (such as keytab or certificate sanity checks) or explain what message to look for.
</p>
<h3 id="Authors">Authors</h3>
<p>
Give credit to authors of the design in this section.
</p>
</body></html>