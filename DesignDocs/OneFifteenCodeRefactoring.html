<html><head><link rel="stylesheet" href="/sssd-test2/trac.css" type="text/css" /><link rel="stylesheet" href="/sssd-test2/wiki.css" type="text/css" /></head><body><h1 id="Coderefactoringforthe1.15release">Code refactoring for the 1.15 release</h1>
<p>
Related ticket(s):
</p>
<ul><li>please see inline
</li></ul><h2 id="Problemstatement">Problem statement</h2>
<p>
SSSD is being very actively developed, adding several major features in
each release. We need to make sure the code stays maintainable and adding
new features in the upcoming release won't increase the cost of maintaining
SSSD long-term.
</p>
<p>
Since SSSD releases are primarily being driven by Fedora and RHEL releases,
the Red Hat employed developers have a fixed amount of time for code
refactoring. Of course, community members and developers are free to submit
their patches on their schedule -- although discussion on the list would
be needed prior to merging any refactoring to not disrupt SSSD release
quality for everyone.
</p>
<h2 id="Usecases">Use cases</h2>
<p>
A typical use-case would be: "A feature X depends on module Y that either
is missing some functionality that is missing or a module that has outlived
its initial design. Changing Y in that module would allow us to implement
X more easily or with less maintenance effort in the future".
</p>
<p>
The goal is to prepare the code for upcoming features without regressing,
so testing after the refactoring is done is mandatory. We should consider
also doing an upstream (pre)release to make it easier to test the changes.
</p>
<h2 id="Proposeditemstoberefactored">Proposed items to be refactored</h2>
<p>
This section lists the proposed tickets along with justifications, scope
and test impact.
</p>
<p>
Given the fixed amount of time, each refactoring has a scope, expressed in
just three high-level buckets - large (a couple of weeks, might take most
of the time of the refactoring "sprint"), medium (a week to two weeks)
or small (a couple of days, up to a week). Each item also lists the affected
modules or functionality, so that we know where we need to improve tests.
</p>
<h3 id="Usethesharedcache_reqmoduleforresponderlook-ups">Use the shared <tt>cache_req</tt> module for responder look-ups</h3>
<p>
Currently each responder (except the InfoPipe responder and several parts
of the NSS responder) copy the logic that checks the cache and contacts
the Data Provider if needed. In 1.15, we should add the missing functionality
into the cache_req module and convert the existing responders (especially
those that look up users and groups, not necessarily other objects like
autofs maps or hosts..) to cache_req.
</p>
<h4 id="BenefittoSSSD">Benefit to SSSD</h4>
<p>
In 1.15, we should look at allowing lookups from trusted domain with a
shortname. But we need to take performance into account and avoid cycling
over all domains including their LDAP server. Then we could switch to
checking the caches of all domains first before checking each domain's
cache and then its server.
</p>
<p>
This goal is tracked by <a class="ext-link" href="https://fedorahosted.org/sssd/ticket/843"><span class="icon">​</span>https://fedorahosted.org/sssd/ticket/843</a> (Login time
increases strongly if more than one domain is configured) and ultimately
by <a class="ext-link" href="https://fedorahosted.org/sssd/ticket/3001"><span class="icon">​</span>https://fedorahosted.org/sssd/ticket/3001</a> ([RFE] Short name input format
with SSSD for users from all domains when domain autodiscovery is used).
</p>
<h4 id="Trackingtickets">Tracking tickets</h4>
<ul><li><a class="ext-link" href="https://fedorahosted.org/sssd/ticket/3151"><span class="icon">​</span>https://fedorahosted.org/sssd/ticket/3151</a> - cache_req: complete the needs of NSS responders
</li><li><a class="ext-link" href="https://fedorahosted.org/sssd/ticket/1126"><span class="icon">​</span>https://fedorahosted.org/sssd/ticket/1126</a> - Reuse cache_req() in responder code
</li></ul><h4 id="Testing">Testing</h4>
<p>
We already have NSS and PAM responder tests. We need to extend them further
to make sure all codepaths we change are tested.
</p>
<h4 id="Scope">Scope</h4>
<p>
Large
</p>
<h3 id="Refactorgrouplookupsforbetterperformance">Refactor group lookups for better performance</h3>
<p>
The <tt>sdap_async_groups.c</tt> module grew organically over time. At the moment,
the module is quite hard to read and repeats some potentially expensive
operations (like looping over all attributes or all members) several times.
</p>
<p>
In order to improve performance, we should refactor this module and test
it extensively.
</p>
<h4 id="BenefittoSSSD1">Benefit to SSSD</h4>
<p>
The <tt>sdap_async_groups.c</tt> module would be better maintainable and we would
remove some performance bottlenecks from the code.
</p>
<h4 id="Trackingtickets1">Tracking tickets</h4>
<ul><li><a class="ext-link" href="https://fedorahosted.org/sssd/ticket/3211"><span class="icon">​</span>https://fedorahosted.org/sssd/ticket/3211</a> - Refactor the sdap_async_groups.c module
</li></ul><h4 id="Testing1">Testing</h4>
<p>
LDAP group lookups can be tested using integration tests, "just" all cases
we change must have corresponding test cases.
</p>
<h4 id="Scope1">Scope</h4>
<p>
Medium
</p>
<h3 id="Refactorthesdap_id_ops.cmodule">Refactor the sdap_id_ops.c module</h3>
<p>
The <tt>sdap_id_ops.c</tt> module was written in time where SSSD only supported
a single domain. One of the things that are repeatedly biting us is that
the module can set the fail over status of the whole domain to
offline. Moreover, the module has no tests and is not easy to read.
</p>
<p>
At this time, it's not clear whether the refactoring would just result in
documenting and testing the module or if it would be worth for example
making the module return error codes for connection errors and let the
caller handle the errors. Alternatively, we might decide to do even more
work and let the fail over code work per-domain, not per-back end, which
probably wouldn't be doable in the given scope. More research is needed.
</p>
<h4 id="BenefittoSSSD2">Benefit to SSSD</h4>
<p>
The module would be better maintainable (currently there are some codepaths
where we even don't know why they were added anymore..), have tests and
we would work towards removing issues with trusted domains setting SSSD
to the offline mode.
</p>
<h4 id="Trackingtickets2">Tracking tickets</h4>
<ul><li><a class="ext-link" href="https://fedorahosted.org/sssd/ticket/1507"><span class="icon">​</span>https://fedorahosted.org/sssd/ticket/1507</a> -  Investigate terminating connections in sdap_ops.c and comment the code some more
</li></ul><p>
Other related tickets include:
</p>
<ul><li><a class="ext-link" href="https://fedorahosted.org/sssd/ticket/2767"><span class="icon">​</span>https://fedorahosted.org/sssd/ticket/2767</a> - The sdap_op code always ends request with EAGAIN
</li><li><a class="ext-link" href="https://fedorahosted.org/sssd/ticket/2976"><span class="icon">​</span>https://fedorahosted.org/sssd/ticket/2976</a> - sdap code can mark the whole sssd_be offline
</li></ul><h4 id="Testing2">Testing</h4>
<p>
Currently upstream has only basic tests with the integration
tests. Downstream has tests for fail over as well.
</p>
<h4 id="Scope2">Scope</h4>
<p>
Medium to large, depending on what changes we decide to do.
</p>
<h3 id="Provideawaytopassintermediatedatabetweenrequests">Provide a way to pass intermediate data between requests</h3>
<p>
As long as a request is confined within a single domain, we can pass around
<tt>sysdb_attrs</tt> or a similar data structure between different requests and
avoid a costly cache writes. However, when a request must include processing
in two different domain types, for example an IPA domain that includes
overrides, the only way to pass intermediate data is to call a sysdb
transaction and save the data to cache so that another request can read them.
</p>
<h4 id="BenefittoSSSD3">Benefit to SSSD</h4>
<p>
Performance benefit in case SSSD must call identity lookup requests from
different domains.
</p>
<h4 id="Trackingtickets3">Tracking tickets</h4>
<ul><li><a class="ext-link" href="https://fedorahosted.org/sssd/ticket/2943"><span class="icon">​</span>https://fedorahosted.org/sssd/ticket/2943</a> - Split out the requests for IPA users and groups that include overrides into reusable requests
</li></ul><h4 id="Testing3">Testing</h4>
<p>
Unfortunately, there are no upstream tests for requests that include
overrides. Testing would be provided by downstream tests.
</p>
<h4 id="Scope3">Scope</h4>
<p>
Medium to large
</p>
<h3 id="UpstreamthePoCteststhatutilizeSambaADforADprovidertesting">Upstream the PoC tests that utilize Samba AD for AD provider testing</h3>
<p>
At the moment, we don't have any upstream tests for the AD provider and
we rely on downstream and manual testing completely. Nikolai Kondrashov
wrote a proof-of-concept patches that provisions an AD DC server provided
by the Samba project using the cwrap wrapper libraries. The scope of this
effort would be to upstream this work.
</p>
<h4 id="BenefittoSSSD4">Benefit to SSSD</h4>
<p>
SSSD integration tests would allow us to write tests for the AD provider.
</p>
<h4 id="Trackingtickets4">Tracking tickets</h4>
<ul><li><a class="ext-link" href="https://fedorahosted.org/sssd/ticket/2818"><span class="icon">​</span>https://fedorahosted.org/sssd/ticket/2818</a> - Investigate if Samba4 in Fedora can be used for SSSD CI
</li></ul><h4 id="Testing4">Testing</h4>
<p>
Some basic tests like looking up a user or a group would be part of this effort.
</p>
<h4 id="Scope4">Scope</h4>
<p>
Medium
</p>
<h3 id="Decreasethefunctionalityofthemonitorprocess">Decrease the functionality of the monitor process</h3>
<p>
SSSD is gradually moving to socket-activated services and in general more
self-contained services rather than implementing a service manager in the
monitor process. The scope of this work would be to further decrease the
dependence of services on the monitor process, such as moving the register
functionality to the services themselves. Ultimately, the monitor process
would perform one-time tasks such as converting the configuration from
INI to confdb and exit.
</p>
<p>
Other work might include a fallback configuration or starting the services
and domains even without having them explicitly enumerated in the services
section.
</p>
<h4 id="BenefittoSSSD5">Benefit to SSSD</h4>
<p>
Socket-activatable services would be better manageable by SSSD.
</p>
<h4 id="Trackingtickets5">Tracking tickets</h4>
<ul><li><a class="ext-link" href="https://fedorahosted.org/sssd/ticket/2231"><span class="icon">​</span>https://fedorahosted.org/sssd/ticket/2231</a> - RFE: Drop the monitor process
</li></ul><h4 id="Testing5">Testing</h4>
<p>
There are no upstream test for this functionality at the moment. Some
service restart tests exist in downstream, though.
</p>
<h4 id="Scope5">Scope</h4>
<p>
Medium to large, but hopefully this task could be split into several
smaller tasks.
</p>
<h3 id="Memorycachechanges">Memory cache changes</h3>
<p>
There are several improvements to the memory cache that we have been
discussing lately, including a memory cache for by-SID lookups or having
the memory cache respect case insensitive domains. The goal of this task
would be to investigate what needs to be changed in the memory cache in
order to implement these improvements.
</p>
<h4 id="BenefittoSSSD6">Benefit to SSSD</h4>
<p>
Better performance through leveraging memory cache for SID lookups and
lookups in case insensitive domains.
</p>
<h4 id="Trackingtickets6">Tracking tickets</h4>
<ul><li><a class="ext-link" href="https://fedorahosted.org/sssd/ticket/3193"><span class="icon">​</span>https://fedorahosted.org/sssd/ticket/3193</a> - [RFE] Support aliases in the memory cache
</li><li><a class="ext-link" href="https://fedorahosted.org/sssd/ticket/2727"><span class="icon">​</span>https://fedorahosted.org/sssd/ticket/2727</a> - Add a memcache for SID-by-id lookups 
</li></ul><h4 id="Testing6">Testing</h4>
<p>
We already have tests for memory cache which could be extended. Tests for
by-SID lookups would probably require us to add the Samba-based tests first.
</p>
<h4 id="Scope6">Scope</h4>
<p>
Probably large, but more investigation is needed.
</p>
<h3 id="SBUSAPIImprovements">SBUS API Improvements</h3>
<p>
Our internal d-bus interface got a lot of new functionality to properly
support D-Bus on public level. The <a class="missing wiki" href="https://docs.pagure.org/sssd-test2/InfoPipe.html" rel="nofollow">InfoPipe?</a> responder has grown and also
our internal communication between responders and providers has become
more advanced.
</p>
<p>
The more we use it, the more it seems that the API that takes care of
managing/terminating/error sbus requests is not optimal, since it requires
a lot of glue code and often requires several output places and return code.
</p>
<p>
We should base sbus handlers on tevent to make sure there is only one output
place and return code (when tevent request finishes) and we should also
improve and simplify API that is used by handlers.
</p>
<h4 id="BenefittoSSSD7">Benefit to SSSD</h4>
<p>
SSSD depends on D-Bus (and thus on sbus) more and more and we will keep adding
new functionality. Reducing the amount of code that needs to be added and simplified
logic will helps us to develop more stable code more quickly.
</p>
<h4 id="Trackingtickets7">Tracking tickets</h4>
<ul><li>none currently
</li></ul><h4 id="Testing7">Testing</h4>
<p>
Sbus is currently heavily tested. We may want to add new tests for new/changed API.
</p>
<h4 id="Scope7">Scope</h4>
<p>
Small.
</p>
<h3 id="Failoverrefactoring">Failover refactoring</h3>
<p>
Failover mechanism wasn't prepared for subdomains and we run into troubles every now
and then. We added several workarounds for cases where the original code wasn't sufficient
but it made the code just more confused. At this moment nobody understands it but bugs
keeps comming.
</p>
<p>
We should have a separate failover context for each domain, instead of one per whole backend.
It must be possible to set different srv mechanism for each context. DNS resolver and cache
should be shared between contexts.
</p>
<h4 id="BenefittoSSSD8">Benefit to SSSD</h4>
<p>
We remove old and problematic code that knowbody understands. We can improve site discovery
for trusted domains and we can have better control over subdomain server resolution.
</p>
<h4 id="Trackingtickets8">Tracking tickets</h4>
<ul><li><a class="ext-link" href="https://fedorahosted.org/sssd/ticket/2393"><span class="icon">​</span>https://fedorahosted.org/sssd/ticket/2393</a>
</li><li><a class="ext-link" href="https://fedorahosted.org/sssd/ticket/2394"><span class="icon">​</span>https://fedorahosted.org/sssd/ticket/2394</a>
</li></ul><h4 id="Testing8">Testing</h4>
<p>
Downstream tests should remain functional, but upstream test will become invalid.
</p>
<h4 id="Scope8">Scope</h4>
<p>
Probably out of four week scope.
</p>
<h2 id="HowToTest">How To Test</h2>
<p>
Run all available upstream and downstream tests, if possible, extend the
upstream tests.
</p>
</body></html>