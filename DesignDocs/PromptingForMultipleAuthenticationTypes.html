<html><head><link rel="stylesheet" href="/sssd-test2/trac.css" type="text/css" /><link rel="stylesheet" href="/sssd-test2/wiki.css" type="text/css" /></head><body><h1 id="PromptingForMultipleAuthenticationTypes">Prompting For Multiple Authentication Types</h1>
<p>
Related ticket(s):
</p>
<ul><li><a class="ext-link" href="https://fedorahosted.org/sssd/ticket/2988"><span class="icon">​</span>https://fedorahosted.org/sssd/ticket/2988</a>
</li></ul><h3 id="Problemstatement">Problem statement</h3>
<p>
Currently FreeIPA only allows one authentication type at a given time for a user. Even if both authentication types 'password' and 'otp' were configured for the user only 'otp' was allowed in that case. Because of this SSSD only had to prompt for either 'Password' or 'First factor' and 'Second factor'.
</p>
<p>
New version of FreeIPA will allow that the sue can authentication with different authentication types at the same time (<a class="ext-link" href="https://fedorahosted.org/freeipa/ticket/433"><span class="icon">​</span>https://fedorahosted.org/freeipa/ticket/433</a>). SSSD now must prompt the user differently to make clear which authentication types are available for the user ideally without making the login process more complicated.
</p>
<h3 id="Usecases">Use cases</h3>
<p>
(taken from <a class="ext-link" href="http://www.freeipa.org/page/V4/Authentication_Indicators"><span class="icon">​</span>http://www.freeipa.org/page/V4/Authentication_Indicators</a>)
</p>
<h4 id="StrongAuthenticationonSelectedSystem">Strong Authentication on Selected System</h4>
<h5 id="Userstory">User story</h5>
<p>
As an Administrator, I want to setup authentication to a critical system in my infrastructure (gateway VPN, accounting system) to only allow IdM users authenticated via strong authentication methods (2FA). I do not want to require strong authentication on other systems.
</p>
<h5 id="Description">Description</h5>
<p>
A realm has two servers configured for ssh which use the following principals configured with authentication indicators:
</p>
<pre class="wiki">    host/lowsecurity.example.com []
    host/highesecurity.example.com [otp radius]
</pre><p>
When the administrator logs in using both his password and an OTP token, he can access both systems via ssh. However, when the administrator logs in using just a password, he can only access lowsecurity.example.com. 
</p>
<h3 id="Overviewofthesolution">Overview of the solution</h3>
<p>
Depending on the available authentication types SSSD will show different login prompts:
</p>
<table class="wiki">
<tr><th> Authentication types </th><th> Login Prompt 
</th></tr><tr><td> password </td><td> Password: 
</td></tr><tr><td> otp </td><td> First factor: <br /> Second factor: 
</td></tr><tr><td> password + otp </td><td> First factor or password: <br /> Second factor, press return for Password authentication: 
</td></tr></table>
<p>
If Smartcard authentication is enabled (<em>pam_cert_auth = True</em>) and a Smartcard is inserted in a reader with a certificate matching the user who wants to login the login prompt will ask for the Smartcard PIN for local authentication (<a class="missing wiki" href="https://docs.pagure.org/sssd-test2/SmartcardAuthenticationStep1.html" rel="nofollow">wiki:SmartcardAuthenticationStep1?</a>). Upcoming support for pkinit might lead to another extension of the prompting scheme.
</p>
<h3 id="Implementationdetails">Implementation details</h3>
<p>
First it has to be noted that this feature is related to Kerberos authentication because here the available authentication types are indicated by the server during the authentication request. Other authentication schemes like e.g. LDAP bind based authentication do support multiple different methods as well, e.g. you can bind to the FreeIPA LDAP server with password and 2FA authentication if the user is configured accordingly. But here the client either has to try which authentication might work or figure out possible authentication methods by other means which might be unreliable.
</p>
<p>
Kerberos indicates the available authentication methods via the available pre-authentication methods listed in the 'Additional pre-authentication required' response. The different pre-authentication methods are implemented as plugins and there are two ways for the plugins to interact with a user. The first one is a prompter callback which can be given as argument to e.g. krb5_get_init_creds_password(). The second, newer and more advanced method, are responders which can be set with krb5_get_init_creds_opt_set_responder() which is available since version 1.11 of MIT Kerberos.
</p>
<p>
For older versions of Kerberos where krb5_get_init_creds_opt_set_responder() is not available nothing changes because those versions do not support OTP either, so only password authentication will be available here.
</p>
<p>
For builds with a newer version of MIT Kerberos all authentication decision will be moved to the responder. This means that calls like krb5_get_init_creds_password() will not get the password as an argument anymore but the password is set inside of the responder if password based authentication is chosen.
</p>
<p>
The responder will check which authentication types are available by calling krb5_responder_list_questions(). If password authentication is available, indicated by the value of KRB5_RESPONDER_QUESTION_PASSWORD and the provided authentication token is of type password as well the password is set as answer to the password authentication and no further methods are considered.
</p>
<p>
If password authentication is not available or the provided authentication token is of type SSS_AUTHTOK_TYPE_2FA the existing OTP responder component is called.
</p>
<p>
During the SSSD pre-authentication request a new pam response is added which indicate that password authentication is available. Based on this and the OTP related response the pam_sss PAM modules can choose the right set of prompts.
</p>
<h3 id="Configurationchanges">Configuration changes</h3>
<p>
No configuration changes are needed on the client the available authentication types are determined based the the responses of the server.
</p>
<h3 id="HowToTest">How To Test</h3>
<p>
First create an IPA user and assign an OTP token to the user, see <a class="ext-link" href="http://www.freeipa.org/page/V4/OTP#How_to_Test"><span class="icon">​</span>http://www.freeipa.org/page/V4/OTP#How_to_Test</a> for details. Additionally two services with different authentication indicator requirements are useful to test the returned credentials but are not necessary to test the prompting.
</p>
<pre class="wiki">$ ipa service-add ANY/ipa-client.example.dom
$ ipa-getkeytab -p ANY/ipa-client.example.com -k /tmp/any.keytab

$ ipa service-add OTP/ipa-client.example.com --auth-ind=otp
$ ipa-getkeytab -p OTP/ipa-client.example.com -k /tmp/otp.keytab
</pre><p>
(the keytab files are not needed for further testing).
</p>
<h5 id="Passwordonly">Password only</h5>
<p>
To test plain password authentication call
</p>
<pre class="wiki">$ ipa user-mod test_user --user-auth-type=password
</pre><p>
and then as an un-privileged user
</p>
<pre class="wiki">$ su - test_user
Password:
</pre><p>
after login you can test by calling
</p>
<pre class="wiki">$ kvno ANY/ipa-client.example.dom@EXAMLE.COM
ANY/ipa-client.example.com@EXAMPLE.COM: kvno = 1
$ kvno OTP/ipa-client.example.dom@EXAMLE.COM
kvno: KDC policy rejects request while getting credentials for OTP/ipa-client.example.dom@EXAMLE.COM
</pre><p>
that only a ticket for the ANY service can be requested but not for the OTP service because only the password was used for authentication.
</p>
<p>
Entering Password+<a class="missing wiki" href="https://docs.pagure.org/sssd-test2/TokenValue.html" rel="nofollow">TokenValue?</a> in a single string at the <em>Password:</em> prompt will cause an authentication failure.
</p>
<h5 id="OTPonly">OTP only</h5>
<p>
The second test is for OTP only authentication
</p>
<pre class="wiki">$ ipa user-mod test_user --user-auth-type=otp
</pre><p>
and then as an un-privileged user call
</p>
<pre class="wiki">$ su - test_user
First Factor: 
Second Factor:
</pre><p>
after login you can test by calling
</p>
<pre class="wiki">$ kvno ANY/ipa-client.example.dom@EXAMLE.COM
ANY/ipa-client.example.com@EXAMPLE.COM: kvno = 1
$ kvno OTP/ipa-client.example.dom@EXAMLE.COM
OTP/ipa-client.example.com@EXAMPLE.COM: kvno = 1
</pre><p>
that tickets for both services can be request successfully because now 2-Factor authentication was used to log in.
</p>
<p>
Entering Password+<a class="missing wiki" href="https://docs.pagure.org/sssd-test2/TokenValue.html" rel="nofollow">TokenValue?</a> in a single string at the <em>First Factor:</em> prompt will authenticate the user successfully as well but features like off-line authentication or unlocking of the user's keyring might not be availble.
</p>
<h5 id="PasswordandOTP">Password and OTP</h5>
<p>
Finally both authentication methods are enabled on the server:
</p>
<pre class="wiki">$ ipa user-mod test_user --user-auth-type=otp --user-auth-type=password
</pre><p>
If now call <em>su</em> as an un-privileged user
</p>
<pre class="wiki">$ su - test_user
First Factor or Password: 
Second Factor, press return for Password authentication:
</pre><p>
you can either just enter the password and press enter at the second prompt or enter the password and the OTP token value at the respective prompt. In the first case only a ticket for the ANY service can be requested:
</p>
<pre class="wiki">$ kvno ANY/ipa-client.example.dom@EXAMLE.COM
ANY/ipa-client.example.com@EXAMPLE.COML: kvno = 1
$ kvno OTP/ipa-client.example.dom@EXAMLE.COM
kvno: KDC policy rejects request while getting credentials for OTP/ipa-client.example.dom@EXAMLE.COM
</pre><p>
If both factor are given tickets for both services can be requested successfully:
</p>
<pre class="wiki">$ kvno ANY/ipa-client.example.dom@EXAMLE.COM
ANY/ipa-client.example.com@EXAMPLE.COM: kvno = 1
$ kvno OTP/ipa-client.example.dom@EXAMLE.COM
OTP/ipa-client.example.com@EXAMPLE.COM: kvno = 1
</pre><p>
Entering Password+<a class="missing wiki" href="https://docs.pagure.org/sssd-test2/TokenValue.html" rel="nofollow">TokenValue?</a> in a single string at the <em>First Factor or Password:</em> prompt will cause an authentication failure.
</p>
<h3 id="HowToDebug">How To Debug</h3>
<p>
If password authentication is not working when both password and OTP authentication are enabled you might hit <a class="ext-link" href="https://bugzilla.redhat.com//show_bug.cgi?id=1340304"><span class="icon">​</span>https://bugzilla.redhat.com//show_bug.cgi?id=1340304</a> and should update the Kerbeors packages.
</p>
<h4 id="Inspectinglogfiles">Inspecting log files</h4>
<p>
Setting <em>debug_level = 9</em> in the <em>[domain/...]</em> section of <em>sssd.conf</em> will add libkrb5 trace messages to the krb5_child.log file which e.g. will show the pre-authentication methods offered by the KDC. Based on this SSSD will determine which authentication methods are available. In the <em>Processing preauth types:</em> line of the trace output <em>141</em> represents the OTP authentication while <em>2</em> (without FAST) or <em>138</em> (with FAST) stand for password authentication.
</p>
<h4 id="Manualtestingwithkinit">Manual testing with kinit</h4>
<p>
If only password authentication or password and OTP authentication are configured for a user kinit should ask for the password:
</p>
<pre class="wiki">$ kinit test_user
Password for test_user@EXAMPLE.COM
</pre><p>
OTP authentication is only available if FAST is enabled. The needed armor credential cache must be requested with kinit as well:
</p>
<pre class="wiki">$ kinit -c ./armor.ccache -k
</pre><p>
which will use the default keytab (/etc/krb5.keytab) which is accessible only by root to get a TGT. For easier testing you can create a special service and give suitable permissions to the service keytab. To use it with kinit use the -t option
</p>
<pre class="wiki">$ kinit -c ./armor.ccache -k -t ./service.keytab
</pre><p>
Now you can call
</p>
<pre class="wiki">$ kinit -T ./armor.ccache test_user
Enter OTP Token Value:
</pre><p>
If OTP is not enable for the user you should see the password prompt.
</p>
<p>
As usual, setting <em>KRB5_TRACE=/dev/stdout</em> before calling <em>kinit</em> or <em>kvno</em> will produce some extra output which might be useful.
</p>
<h3 id="Authors">Authors</h3>
<ul><li>Sumit Bose &lt;<a class="mail-link" href="mailto:sbose@redhat.com"><span class="icon">​</span>sbose@redhat.com</a>&gt;
</li></ul></body></html>