<html><head><link rel="stylesheet" href="/sssd-test2/trac.css" type="text/css" /><link rel="stylesheet" href="/sssd-test2/wiki.css" type="text/css" /></head><body><h1 id="SSSCTL">SSSCTL</h1>
<p>
Related ticket(s):
</p>
<ul><li><a class="ext-link" href="https://fedorahosted.org/sssd/ticket/385"><span class="icon">​</span>https://fedorahosted.org/sssd/ticket/385</a>
</li><li><a class="ext-link" href="https://fedorahosted.org/sssd/ticket/1788"><span class="icon">​</span>https://fedorahosted.org/sssd/ticket/1788</a>
</li><li><a class="ext-link" href="https://fedorahosted.org/sssd/ticket/1828"><span class="icon">​</span>https://fedorahosted.org/sssd/ticket/1828</a>
</li><li><a class="ext-link" href="https://fedorahosted.org/sssd/ticket/2166"><span class="icon">​</span>https://fedorahosted.org/sssd/ticket/2166</a>
</li><li><a class="ext-link" href="https://fedorahosted.org/sssd/ticket/2954"><span class="icon">​</span>https://fedorahosted.org/sssd/ticket/2954</a>
</li><li><a class="ext-link" href="https://fedorahosted.org/sssd/ticket/2957"><span class="icon">​</span>https://fedorahosted.org/sssd/ticket/2957</a>
</li></ul><h3 id="Problemstatement">Problem statement</h3>
<p>
Main purpose of this task is to make administration &amp; debugging tasks more user friendly and thus hopefully save time of users, support and developers.
</p>
<p>
SSSCTL will be CLI client using the SSSD infopipe as a server that will be providing necessary data and will perform/delegate commands to the SSSD providers and responders.
</p>
<h3 id="Usecases">Use cases</h3>
<ul><li>online/offline state (<a class="ext-link" href="https://fedorahosted.org/sssd/ticket/385"><span class="icon">​</span>https://fedorahosted.org/sssd/ticket/385</a>). Users have repeatedly asked for simple mean how to check if data provider is offline or online without need to check logs (if logging is enabled at all).
</li><li>Report whether the entry is present in SSSD cache (<a class="ext-link" href="https://fedorahosted.org/sssd/ticket/2166"><span class="icon">​</span>https://fedorahosted.org/sssd/ticket/2166</a>)
</li><li>Check if the cached entry is valid and refresh if appropriate (<a class="ext-link" href="https://fedorahosted.org/sssd/ticket/2166"><span class="icon">​</span>https://fedorahosted.org/sssd/ticket/2166</a>)
</li><li>Measure the time an operation took (useful in performance tuning, <a class="ext-link" href="https://fedorahosted.org/sssd/ticket/385"><span class="icon">​</span>https://fedorahosted.org/sssd/ticket/385</a>)
</li><li>Failover status - Current state of failover process
</li><li>Display server to which provider is connected to (<a class="ext-link" href="https://fedorahosted.org/sssd/ticket/385"><span class="icon">​</span>https://fedorahosted.org/sssd/ticket/385</a>)
</li><li>Display current debug level of a component
</li><li>Generate memory report - Usually when user is observing a memory leak we provide him a special build that generates talloc report which we can then analyze. Using this tool customer would simply select SSSD component that is supposed to leak memory and generate the talloc report immediately.
</li><li>Removing cache - Removing SSSD cache seems to be often misused act done by administrators as there are few real needs for that. Nevertheless, if administrator decides to remove the cache it would be better to do this using the tool instead of crude removing directories that might contain other useful data and could lead to serious problems. Q: Is this what was requested as 'force reload'? Q: Should this rather be part of sss_cache tool?
</li></ul><h3 id="Toolinterface">Tool interface</h3>
<p>
The up-to-date list of all available commands can be printed with
</p>
<pre class="wiki"># sssctl --help
</pre><h4 id="Domaininformation">Domain information</h4>
<p>
List of all domain available within SSSD can be obtain with the following command.
</p>
<pre class="wiki"># sssctl domain-list
</pre><p>
We can also get more information about specific domain.
</p>
<pre class="wiki"># sssctl domain-status $domain [--online, --last-request, --active-server, --servers]
Online status: Online/Offline
Active server: $currently-conected-server (server status, port status, resolver status)

Primary servers:
    first.example.com (server status, port status, resolver status)
    second.example.com (server status, port status, resolver status)

Backup servers:
    first.example.com (server status, port status, resolver status)
    second.example.com (server status, port status, resolver status)

10 most recent requests:
$req-name: started at XXX, finished at XXX, total duration XXX, success/error/...
...
</pre><p>
If a parameter is present only selected part will be printed.
</p>
<h4 id="Informationaboutcachedentry">Information about cached entry</h4>
<p>
Unless we want to use dn, we need to specify whether we want to work with user/group/sudo/..., interface for user follows, other object may be done similarly.
</p>
<pre class="wiki"># sssctl user-show $objname
User $objname is not present in cache.

# sssctl user-show $objname
Cache entry creation date: XXX
Cache entry last update date: XXX
Cache entry expiration date: XXX
</pre><p>
To force an update of the cached entry:
</p>
<pre class="wiki"># sssctl user-show $objname --update
</pre><h4 id="Debuglevel">Debug level</h4>
<pre class="wiki"># sssctl logs-level [--monitor --nss --pam ... --domain $domain]
Monitor: 0x00f0
NSS responder: 0x3ff0
...
Domain $domain: 0xfff0
</pre><p>
Optionally we can provide a debug level to set (taking over sss_debuglevel tool, since we already have D-Bus functionality in place).
</p>
<pre class="wiki"># sssctl logs-level [--monitor --nss --pam ... --domain $domain] $new-level
Monitor: 0x00f0
NSS responder: 0x3ff0
...
Domain $domain: 0xfff0
</pre><p>
If a parameter is present only selected components are shown/changed.
</p>
<h4 id="Tallocreport">Talloc report</h4>
<pre class="wiki"># sssctl memory-report [--monitor --nss --pam ... --domain $domain] $file
</pre><p>
If a parameter is present memory report is generated only for selected components.
</p>
<h4 id="Cacheoperations">Cache operations</h4>
<pre class="wiki"># sssctl client-data-backup [--dir=$outputdir] [--force]
</pre><p>
This command will backup all local data that are not present on the server such as local view and local users. If an <em>$outputdir</em> is specified data will be stored there otherwise <em>/var/lib/sss/backup</em> will be used. If <em>--force</em> option is specified than the existing backup is replaced with the new one.
</p>
<pre class="wiki"># sssctl client-data-restore [--dir=$outputdir]
</pre><p>
Restore local data with the content stored in <em>$outputdir</em>.
</p>
<pre class="wiki"># sssctl cache-remove
</pre><p>
Remove SSSD cache database files, however in a manner that will backup all local data so it can be restored later. The user is notified that removing the cache will destroy all cached data and it is therefore not recommended to do it in offline mode.
</p>
<h3 id="Overviewofthesolution">Overview of the solution</h3>
<p>
We will create a new administrator tool called <strong>sssctl</strong>. This tool will communicate with <strong>InfoPipe</strong> responder through its <strong>public D-Bus interface</strong>. The InfoPipe will then internally forward the messages to other SSSD components as necessary.
</p>
<p>
In cases where <strong>sssctl</strong> can be replaces with combination of existing SSSD or system tools we will just call those tools directly through system call or through their API if exist. For example the remove cache operation is a sequence of: <em>sss_override user-export $dir/view_users.bak &amp;&amp; sss_override group-export $dir/view_groups.bak &amp;&amp; rm -f /var/lib/sss/db/*</em> so we can just call those programs.
</p>
<h3 id="Questions">Questions</h3>
<ul><li><strong>Q1</strong>: [Domain; Last request] What would be preferred number of request to be printed? Do we wan't a parameter for this in sssd.conf or even make it possible to change this value dynamically? 
<ul><li>Start with fixed number of 10 request and keep it unless a bigger requirenment comes.
</li></ul></li><li><strong>Q2</strong>: [Domain; Server list] Is it enough to print only active server or do we want full list of primary and backup servers as well?
<ul><li>Print full list containing also discovered servers.
</li></ul></li><li><strong>Q3</strong>: [Domain; Server list] Do we want to also print IP adresses?
<ul><li>Not needed.
</li></ul></li><li><strong>Q4</strong>: [Talloc report] Should we provide parameter $file or should we hardcod the path as SSSD logs directory, generating name from component and time?
<ul><li>Provide a file parameter but default to log directory.
</li></ul></li></ul><h3 id="Configurationchanges">Configuration changes</h3>
<p>
No configuration changes.
</p>
<h3 id="HowToTest">How To Test</h3>
<p>
Not at the moment.
</p>
<h3 id="HowToDebug">How To Debug</h3>
<p>
Not at the moment.
</p>
<h3 id="Authors">Authors</h3>
<p>
Pavel Reichl &lt;<a class="mail-link" href="mailto:preichl@redhat.com"><span class="icon">​</span>preichl@redhat.com</a>&gt;
</p>
<p>
Pavel Březina &lt;<a class="mail-link" href="mailto:pbrezina@redhat.com"><span class="icon">​</span>pbrezina@redhat.com</a>&gt;
</p>
</body></html>