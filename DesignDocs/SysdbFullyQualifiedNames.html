<html><head><link rel="stylesheet" href="/sssd-test2/trac.css" type="text/css" /><link rel="stylesheet" href="/sssd-test2/wiki.css" type="text/css" /></head><body><h1 id="ChangeformatofSYSDB_NAMEattributeforusersandgroups">Change format of SYSDB_NAME attribute for users and groups</h1>
<p>
Related ticket(s):
</p>
<ul><li><a class="ext-link" href="https://fedorahosted.org/sssd/ticket/2011"><span class="icon">​</span>https://fedorahosted.org/sssd/ticket/2011</a>
</li></ul><h3 id="Problemstatement">Problem statement</h3>
<p>
Currently the "name" (SYSDB_NAME) attribute for users and groups can be stored
in different formats depending on domain configuration, in particular the
<tt>full_name_format</tt> option. If the domain does not require fully-qualified
domain names (FQDN), the name in SYSDB_NAME is stored without the domain
portion (for example <tt>joe</tt>). If FQDN is required in the domain, then the
domain portion is stored in the SYSDB_NAME attribute (for example
<tt>joe@example.com</tt>). The format in which the FQDN is stored is stored is also
configurable in sssd.conf.
</p>
<p>
There are two major problems with this approach:
</p>
<ul><li>For admins - The format of data in sysdb is dependent on SSSD
configuration. Changes in sssd.conf may render the cached data invalid, so
admins have to remove the cache. In general, allowing an option that should
purely control the ouput format to also control the database layout is a
very bad idea.
</li></ul><ul><li>For code maintainers - The code that deals with SYSDB_NAME attribute
often contains conditions and multiple branches to treat the FQDN/non-FQDN
names differently. This makes the code less readable and more fragile.
</li></ul><p>
In addition, some features such as using only the name part for subdomain users
are very hard to implement with the current code.
</p>
<h3 id="Usecases">Use cases</h3>
<p>
As an Administrator, I would like an option to only output the short names of
trusted AD users without the domain component.
</p>
<p>
As an Administrator, I would like to change the output name format without
having the flush the whole database.
</p>
<p>
As a code maintainer, I need a predictable way to store user and group entries
without special casing the name formats.
</p>
<h3 id="Overviewofthesolution">Overview of the solution</h3>
<p>
Always store SYSDB_NAME attribute for users and groups in special internal
FQDN format that is not configuration dependent. The options
<tt>use_fully_qualified_names</tt> and <tt>full_name_format</tt> should only be relevant for
code that prepares data for user output. Internally, only the internal FQDN
should be used.
</p>
<p>
Using a fully qualified name (as opposed to a non-qualified name) for all
users is better to make it possible to use the <tt>memberUid</tt> and <tt>ghost</tt>
attributes in our ldb cache for cases where a group stores members from
multiple domains.
</p>
<h3 id="Implementationdetails">Implementation details</h3>
<p>
The new internal FQDN will have the following format: <tt>name@domain</tt>.
The name portion will retain the original case, while the domain portion
will be normalized as lower-case. The SYSDB_ALIAS attribute will have the
same format, but lowercased. The database will not store the shortname
for users and groups at all, but the code would parse the shortname if
needed. This is acceptable because the shortname would only be needed during
interaction with outside of SSSD, such as creating filters or during output.
</p>
<p>
The name that SSSD receives from the client libraries would be converted
to the internal format when a responder loops over a domain, much like we
normalize the case at the moment. The back end would receive the qualified
name as part of the <tt>be_req</tt> structure already and internally would work
with the qualified name only except places where we need to use the name
portion only (such as when constructing an LDAP filter).
</p>
<p>
All functions that work with user and/or group names should be modified to accept
this format.
</p>
<p>
When working on the conversion, care must be taken to not tie the code to any
particular format, but always use functions to create or parse the internal
name. This could be tested by changing the functions to create and parse the format
to create the FQDN in a different format and making sure all tests still pass.
</p>
<p>
A sysdb version upgrade will be necessary. The changes in sysdb will be following:
</p>
<ul><li>Change the SYSDB_NAME attribute for users and groups to use the new internal format.
</li><li>Use the new internal format for SYSDB_GHOST and SYSDB_MEMBERUID attributes.
</li><li>The member and memberof attributes will have to be changed to use the 
</li></ul><h4 id="sysdbupgrade">sysdb upgrade</h4>
<p>
The sysdb upgrade is tricky for two reasons:
</p>
<ol><li>the amount of data we'll have to change and write can potentially be
huge if the database contains many users and groups.  To mitigate the
performance impact, we will open the database in a nosync mode, perform
all the writes at once and flush when we are done.
</li><li>the memberof plugin normally prevents the ldb user to write the
SYSDB_MEMBERUID, SYSDB_GHOST and SYSDB_MEMBEROF attributes directly.
Because there is no way to selectively disable one module when connecting
to ldb, we will have to add a way to the memberof plugin to allow the user
to bypass the module (maybe when an environment variable is set)
</li></ol><p>
Additionaly, because this update is risky, we should perform the update on a
copy of the database and only rename the copy when the upgrade finishes
successfully. This would allow the admin to downgrade sssd back and still use
the original database in the previous format.
</p>
<h3 id="Configurationchanges">Configuration changes</h3>
<p>
No configuration changes required, this is internal change only.
</p>
<h3 id="HowToTest">How To Test</h3>
<p>
All available tests should still pass. The tests should also pass if the
format of the database was changed.
</p>
<h3 id="Authors">Authors</h3>
<ul><li>Jakub Hrozek &lt;<a class="mail-link" href="mailto:jhrozek@redhat.com"><span class="icon">​</span>jhrozek@redhat.com</a>&gt;
</li><li>Michal Židek &lt;<a class="mail-link" href="mailto:mzidek@redhat.com"><span class="icon">​</span>mzidek@redhat.com</a>&gt;
</li></ul></body></html>