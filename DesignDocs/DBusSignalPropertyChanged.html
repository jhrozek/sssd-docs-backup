<html><head><link rel="stylesheet" href="/sssd-test2/trac.css" type="text/css" /><link rel="stylesheet" href="/sssd-test2/wiki.css" type="text/css" /></head><body><h1 id="D-BusSignal:NotifyPropertyChanged">D-Bus Signal: Notify Property Changed</h1>
<p>
Related ticket(s):
</p>
<ul><li><a class="ext-link" href="https://fedorahosted.org/sssd/ticket/2233"><span class="icon">​</span>https://fedorahosted.org/sssd/ticket/2233</a>
</li></ul><p>
Related design page(s):
</p>
<ul><li><a class="ext-link" href="https://docs.pagure.org/sssd-test2/DesignDocs/DBusResponder.html"><span class="icon">​</span>https://fedorahosted.org/sssd/wiki/DesignDocs/DBusResponder</a>
</li></ul><h3 id="Problemstatement">Problem statement</h3>
<p>
This design document describes how to implement org.freedesktop.DBus.Properties.PropertiesChanged signal for SSSD objects exported in the IFP responder.
</p>
<h2 id="D-BusInterface">D-Bus Interface</h2>
<h3 id="org.freedesktop.DBus.Properties">org.freedesktop.DBus.Properties</h3>
<h4 id="Signals">Signals</h4>
<ul><li>PropertiesChanged(s interface_name, {sv} changed_properties, as invalidated_properties)
<ul><li>interface_name: name of the interface on which the properties are defined
</li><li>changed_properties: changed properties with new values
</li><li>invalidated_properties: changed properties but the new values are not send with them
</li><li>this signal is emitted for every property annotated with org.freedesktop.DBus.Property.EmitsChangedSignal, this annotation may be also used for the whole interface meaning that every property within this interface emits the signal
</li></ul></li></ul><h3 id="Overviewofthesolution">Overview of the solution</h3>
<p>
Changes in properties are detected in new LDB plugin inside a <em>mod</em> hook. The plugin writes list of changed properties in a TDB-based changelog which is periodically consumed by IFP responder. IFP then emits PropertiesChanged signal per each modified object.
</p>
<h3 id="Implementationdetails">Implementation details</h3>
<h4 id="TDBFormat">TDB Format</h4>
<ul><li><strong>TDB Name</strong>: <em>ifp_changelog.tdb</em>
</li><li><strong>Key</strong>: dn of modified object
</li><li><strong>Value</strong>: chained list of modified properties in the form <em>total_num\0prop1\0prop2\0...\0</em>
</li></ul><h4 id="IFPSide">IFP Side</h4>
<ol><li>TDB database is created on IFP start and deleted on IFP termination.
<ul><li>on IFP start:
<ul><li>if TDB file does not exist it is created
</li><li>if TDB file exist (unexpected termination of IFP) it is flushed, we do not care about the data inside
</li></ul></li><li>on correct IFP termination
<ul><li>the TDB file is deleted
</li></ul></li></ul></li><li>A periodic task <em>IFP: notify properties changed</em> is created, it is responsible for emitting the <em>PropertiesChanged</em> signal
<ul><li>Periodic task flow:
<ol><li>Lock TDB for read-only access
</li><li>Traverse the TDB and remember dn and properties for all modified objects
</li><li>Flush TDB
</li><li>Release the lock
</li><li>Create and emit D-Bus signal per each object that is exported on IFP bus and supports <em>PropertiesChanged</em> signal
</li></ol></li></ul></li></ol><h4 id="LDBPluginSide">LDB Plugin Side</h4>
<ol><li>If TDB file does not exist just quit
</li><li>If modified object supports the signal store it in the TDB
</li></ol><h3 id="Configurationchanges">Configuration changes</h3>
<p>
In IFP section:
</p>
<ul><li><strong>ifp_notification_interval</strong>: period of <em>IFP: notify properties changed</em>, disabled if 0, default 300 (5 minutes)
</li></ul><h3 id="HowToTest">How To Test</h3>
<ol><li>Hook onto <em>PropertiesChanged</em> signal, e. g. with <em>dbus-monitor'̈́'
</em></li><li>Trigger change of user/group
</li><li>Signal should be recieved
</li></ol><h3 id="Questions">Questions</h3>
<ol><li>Do we want to use <em>changed_properties</em> or <em>invalidated_properties</em>
</li></ol><h3 id="Authors">Authors</h3>
<ul><li>Pavel Březina &lt;<a class="mail-link" href="mailto:pbrezina@redhat.com"><span class="icon">​</span>pbrezina@redhat.com</a>&gt;
</li></ul></body></html>