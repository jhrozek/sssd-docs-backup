<html><head><link rel="stylesheet" href="/sssd-test2/trac.css" type="text/css" /><link rel="stylesheet" href="/sssd-test2/wiki.css" type="text/css" /></head><body><h1 id="RunningSSSDasanon-rootuser">Running SSSD as a non-root user</h1>
<p>
Related ticket(s):
</p>
<ul><li><a class="ext-link" href="https://fedorahosted.org/sssd/ticket/2370"><span class="icon">​</span>https://fedorahosted.org/sssd/ticket/2370</a>
</li></ul><h3 id="Problemstatement">Problem statement</h3>
<p>
Currently, all SSSD processes run as the root user. However, if one of the
processes was compromised, this might lead to compromising the whole system,
especially if additional measures like SELinux were not enabled. It would
improve security if instead SSSD was running as its own private user, This
design page summarizes what would be needed to run sssd as a non-privileged
user and all the cases that currently require a root user.
</p>
<h3 id="Usecase">Use case</h3>
<p>
This is a general use-case, following the principle of least privilege. The
processes should not run as root unless they really need the root privileges.
</p>
<h2 id="Implementationdetails">Implementation details</h2>
<p>
At a higher level, the changes would amount to:
</p>
<ul><li>A new system user would be created. This user must be added in sssd.spec during the <tt>%pre</tt> section.
</li><li>Files that were used by sssd and previously owned by root should now be owned as the sssd user. This includes the LDB databases.
</li><li>Responders and back ends would drop privileges and become the sssd user as soon as possible, ideally as the first action after startup.
</li><li>Short-lived processes that are spawned by <tt>sssd_be</tt> but might still require elevated privileges would be setuid root.
</li></ul><p>
The changes to individual binaries and files are described in more detail
below. After the changes are implemented, the code that runs as root will
be reduced to the monitor process and the setuid helpers.
</p>
<h2 id="Anewsystemuser">A new system user</h2>
<p>
The sssd will run as a new system user called simply <tt>sssd</tt>. We do not
need to have the UID fixed across systems as no files owned by SSSD are
shared among different systems. The user will be simply added during the
<tt>%pre</tt> phase:
</p>
<pre class="wiki">%pre
getent group sssd &gt;/dev/null || groupadd -r sssd
getent passwd sssd &gt;/dev/null || useradd -r -g sssd -d / -s /sbin/nologin -c "User for sssd" sssd
</pre><p>
As it's common practice for system users, the shell will be <tt>/sbin/nologin</tt>
so the user cannot log in into the system.
</p>
<h3 id="Configurationoptions">Configuration options</h3>
<p>
To be on the safe side, sssd will allow configuring the user to run as. This
option will also allow root, to allow users to keep the old behaviour around
in case they hit a bug with the unprivileged process. As a first step,
we will include these options, but leave the default as 'root'. When we're
certain the non-root sssd works for most users as a non-privileged user,
we will switch the default to the sssd user.
</p>
<h2 id="DroppingprivilegesoftheSSSDprocesses">Dropping privileges of the SSSD processes</h2>
<p>
The goal is for the "worker" processes (that is, both responders and
providers) to drop the root privileges as soon as possible - typically right
after startup, or alternatively after completing any work that requires
root privileges such as opening a file. Because the processes might have to keep the root
privileges after startup, the monitor process would still be running as root.
</p>
<h3 id="Monitorsssd">Monitor (sssd)</h3>
<p>
The monitor process would keep running as root. This is in order to be
able to fork and exec processes that are initially privileged without
making them all setuid. As a future enhancement, the process management
functionality of the monitor will be delegated to systemd (see ticket <a class="closed ticket" href="https://fedorahosted.org/sssd/ticket/2243" title="enhancement: [RFE] Socket-activate responders (closed: fixed)">#2243</a>).
</p>
<h3 id="Responders">Responders</h3>
<p>
The responder processes are by nature 'readers' that mostly read data from
cache and request cache updates from the back end processes.
</p>
<h4 id="NSSresponder">NSS responder</h4>
<p>
The NSS responder can drop privileges after startup. The files that the
NSS responder reads (sysdb, confdb, NSS pipe) and writes (memory cache,
debug logs, NSS pipe) will be owned by the sssd user.
</p>
<h4 id="PAMresponder">PAM responder</h4>
<p>
The PAM responder can drop privileges after startup. The files that the PAM
responder reads (sysdb, confdb, PAM public pipe) and writes (debug logs,
PAM pipe) will be owned by the sssd user.
</p>
<p>
In order to keep the privileged pipe only owned by the root user, we
would open the pipe prior to becoming user and pass the file descriptor.
</p>
<h4 id="InfoPiperesponder">InfoPipe responder</h4>
<p>
The InfoPipe responder can drop privileges after startup. The files that the InfoPipe
responder reads (sysdb, confdb) and writes (debug logs,
PAM pipe) will be owned by the sssd user.
</p>
<p>
Contrary to other responders, the InfoPipe responder doesn't have a public
pipe. The InfoPipe responder also binds to the system bus, we must also
convert the bus policy file to allow the sssd user to bind to the bus.
</p>
<p>
Currently there is also functionality to modify sssd.conf from the <a class="missing wiki" href="https://docs.pagure.org/sssd-test2/InfoPipe.html" rel="nofollow">InfoPipe?</a>. During feature design review, it was suggested that a configuration interface doesn't belong to the <a class="missing wiki" href="https://docs.pagure.org/sssd-test2/InfoPipe.html" rel="nofollow">InfoPipe?</a>
code at all and should be moved to a separate helper. Until that is done, the <a class="missing wiki" href="https://docs.pagure.org/sssd-test2/InfoPipe.html" rel="nofollow">InfoPipe?</a> responder must keep running as root. The work on splitting the <a class="missing wiki" href="https://docs.pagure.org/sssd-test2/InfoPipe.html" rel="nofollow">InfoPipe?</a> is tracked by <a class="ext-link" href="https://fedorahosted.org/sssd/ticket/2395"><span class="icon">​</span>https://fedorahosted.org/sssd/ticket/2395</a>
</p>
<h4 id="AutofsSUDOandSSHresponders">Autofs, SUDO and SSH responders</h4>
<p>
The Autofs, SUDO and SSH responders only read from the sysdb, confdb and
their respective UNIX public pipes. These responders also only write to
the debug logs and the public pipe, all of which would be owned by the
sssd user. This means the Autofs, SUDO and SSH responders can drop privileges
right after startup.
</p>
<h3 id="Providers">Providers</h3>
<p>
The providers are dynamically loadable libraries that are loaded by the
<tt>sssd_be</tt> process. After startup, the sssd_be process dlopens the provider
library and dlsyms the handlers. During sssd operation, the <tt>sssd_be</tt> process
mostly unpacks requests arriving on the SBUS and calls the provider-specific
handlers.
</p>
<p>
Several areas of the initialization still require elevated privileges:
</p>
<ul><li>Checking for principals in the keytab
</li><li>Checking for user TGTs to be renewed
</li></ul><p>
Therefore, the initialization is still performed with root privileges and sssd_be
drops to a non-root user post initialization. See the "Future Enhancements" section for
ideas on reducing the code that runs as root during initialization even further.
</p>
<h3 id="Short-livedprocesses">Short-lived processes</h3>
<p>
The purpose of the short-lived processes is to avoid blocking calls by
performing an otherwise blocking action in a completely separate process.
</p>
<h4 id="ldap_child">ldap_child</h4>
<p>
The ldap_child subprocess primes the credential cache used to establish
GSSAPI-encrypted connection. In order to do so, the ldap_child process needs
to be able to read the keytab, which is readable by root only. Therefore, the
ldap_child process is setuid root, with permissions set to 4750 to make sure
only the sssd user can run the ldap_child process. As soon as the
credentials are obtained, the ldap_child drops privileges and continues running
as the sssd user -- hence also the resulting ccache is owned by the sssd user.
</p>
<h4 id="krb5_child">krb5_child</h4>
<p>
The user krb5_child runs as depends on how the SSSD back end is set up. In the
simplest case, where neither validation nor FAST are used, the krb5_child can
drop privileges to the user who is logging in after startup and runs unprivileged
except for the initialization part.
</p>
<p>
In case either validation or FAST are used, part of the krb5_child runs as root.
Once the resulting ccache is validated using the keytab, the krb5_child process drops
privileges to the user who is logging in.
</p>
<p>
See the "Future Enhancements section" for discussion of using the MEMORY ccache
to reduce the time krb5_child runs as root.
</p>
<h4 id="proxy_child">proxy_child</h4>
<p>
In general, we can't make assumptions on what the PAM module we wrap using the proxy backend
requires, so at least the part of proxy child that runs the PAM conversation should
run as root. During development, we should consider splitting the proxy_child into a small
setuid helper that would still run privileged and only wrap the PAM module and the rest
of the proxy_child that would run unprivileged.
</p>
<h4 id="gpo_child">gpo_child</h4>
<p>
The gpo_child process connects to a SMB share, downloads a GPO policy file
and stores it locally, by default in <tt>/var/lib/sss/gpo_cache</tt>. The gpo_child
authenticates to the SMB share using Kerberos; the ccache, as created by
ldap_child is already accessible to the sssd user. Since that directory would
be owned by the sssd user, the gpo_child could run unprivileged.
</p>
<h4 id="sshhelpers">ssh helpers</h4>
<p>
The SSH helpers already run non-privileged. <tt>sss_ssh_knownhostsproxy</tt> runs
as the user who initiated the SSH session. <tt>sss_ssh_authorizedkeys</tt> runs as
the user specified with the AuthorizedKeysCommandUser directive in sshd_config.
</p>
<h3 id="Commandlinetools">Command line tools</h3>
<p>
There are two general kinds of command line tools we ship with the SSSD - tools that manage accounts in the local backend and SSSD management
tools. All tools check if they are executed by root currently. I think
this check makes sense and should stay because all the tool are intended
for administrative purposes only.
</p>
<p>
Some of the tools can be changed to drop privileges. However, the attach
surface of these tools is small, so changing them is not a priority. This
effort is rather tracked in the Future Enhancements.
</p>
<h4 id="Localbackendtools">Local back end tools</h4>
<p>
The tools either write (`sss_useradd, userdel, usermod, sss_groupadd,
groupdel, groupmod<tt>) or read  (</tt>sss_groupshow<tt>) the </tt>sssd.ldb` file. But additionally, 
these tools also set the SELinux context of the user. Since there is no capability
to call semanage, setting the context still requires root privileges.
</p>
<h4 id="sss_seedandsss_cache">sss_seed and sss_cache</h4>
<p>
These two tools function similarly to the local backend management tools,
except they manipulate the domain cache. The cache is also owned and
writable by the sssd user, so would be safe to drop privileges here, too.
</p>
<h4 id="sss_debuglevel">sss_debuglevel</h4>
<p>
The sss_debuglevel tool changes the debug level of sssd on the fly. The
tool writes new debug level values to the confdb (owned by sssd) and
touches sssd.conf (ownership tbd). The tool can drop privileges to sssd
after startup.
</p>
<h4 id="sss_obfuscate">sss_obfuscate</h4>
<p>
The sss_obfuscate tool is written in Python and manipulates the
sssd.conf file by obfuscating the input and using it as a value of the
<tt>ldap_default_authtok</tt> configuration option. For dropping privileges of
the sss_obfuscate tool, we can use the python bindings of libcap-ng. Again,
making this tool non-privileged is not a priority.
</p>
<h2 id="Externalresourcescurrentlyrequiringrootaccess">External resources currently requiring root access</h2>
<p>
This part of the design page summarizes which external resources, typically
file system objects currently require SSSD to have elevated privileges.
</p>
<p>
For filesystem objects, we can either change their owner to the sssd
local user, add an ACL or open them as the privileged process and pass
the file descriptor.
</p>
<h3 id="SSSDconfigurationfile">SSSD configuration file</h3>
<ul><li>Filesystem path: <tt>/etc/sssd/sssd.conf</tt>
</li><li>Current owner and permissions: root.root 0600
</li><li>Read by: The monitor process
</li><li>Written to by: The InfoPipe responder and users of the configAPI, such as sss_obfuscate or authconfig
</li><li><em>Change: Currently the permissions will stay the same as the monitor process and the <a class="missing wiki" href="https://docs.pagure.org/sssd-test2/InfoPipe.html" rel="nofollow">InfoPipe?</a> still run as root</em>
</li></ul><h3 id="Debuglogs">Debug logs</h3>
<ul><li>Filesystem path: <tt>/var/log/sssd/*.log</tt>
</li><li>Current owner and permissions: root.root 0600
</li><li>Read by: N/A, only externally by admin
</li><li>Written to by: monitor, providers, responders, child processes
</li><li><em>New owner and permissions: sssd.sssd 0600</em>
</li></ul><h3 id="Theconfigurationdatabase">The configuration database</h3>
<ul><li>Filesystem path: <tt>/var/lib/sss/db/config.ldb</tt>
</li><li>Current owner and permissions: root.root 0600
</li><li>Read by: responders, providers, monitor, command-line tools
</li><li>Written to by: The monitor process, sssd-ad (a single confdb_set call), sss_debuglevel, sssd_ifp
</li><li><em>New owner and permissions: sssd.sssd 0600</em>
</li></ul><h3 id="Theon-diskcachesysdb">The on-disk cache (sysdb)</h3>
<ul><li>Filesystem path: <tt>/var/lib/sss/db/cache_$domain.ldb</tt>
</li><li>Current owner and permissions: root.root 0600
</li><li>Read by: responders, providers, command-line tools
</li><li>Written to by: sssd_be, the CLI tools
</li><li><em>New owner and permissions: sssd.sssd 0600</em>
</li></ul><h3 id="MemoryCache">Memory Cache</h3>
<ul><li>Filesystem path: <tt>/var/lib/sss/mc/{passwd,group}</tt>
</li><li>Current owner and permissions: root.root 0644
</li><li>Read by: The SSS NSS module
</li><li>Written to by: The NSS responder
</li><li><em>New owner: sssd.sssd permissions will stay the same</em>
</li></ul><h3 id="Kerberoskeytab">Kerberos keytab</h3>
<ul><li>Filesystem path: configurable, <tt>/etc/krb5.keytab</tt> by default
</li><li>Current owner and permissions: root.root 0600
</li><li>Read by: LDAP, KRB5, IPA, AD providers, krb5_child, ldap_child
</li><li>Written to by: sssd_be, the CLI tools
</li><li><em>Change: No change at the moment. The keytab will be kept readable by the root user only</em>
</li></ul><h3 id="Kerberosusercredentialcache">Kerberos user credential cache</h3>
<ul><li>Filesystem path: Configurable, only if FILE or DIR based cache is used, which is not the default anymore
</li><li>Current owner and permissions: the user who logged in, 0600
</li><li>Read by: KRB5, AD, IPA, krb5_child, libkrb5 externally
</li><li>Written to by: krb5_child
</li><li><em>Change: No change, the credential cache will still be written as the user in question</em>
</li></ul><h3 id="KerberosLDAPcredentialcache">Kerberos LDAP credential cache</h3>
<ul><li>Filesystem path: <tt>/var/lib/sss/db/ccache_$domain</tt>
</li><li>Current owner and permissions: root.root 0600
</li><li>Read by: AD, IPA and LDAP providers (coded up in LDAP provider tree)
</li><li>Written to by: ldap_child
</li><li>No change needed since ldap_child will run as the sssd user in the new design
</li><li><em>New owner and permissions: sssd.sssd 0600</em>
</li></ul><h3 id="Kerberoskdcinfofiles">Kerberos kdcinfo files</h3>
<ul><li>Filesystem path: <tt>/var/lib/sss/pubconf/*</tt>
</li><li>Current owner and permissions: root.root. The directory has permissions of 0755, the files 0644
</li><li>Read by: libkrb5
</li><li>Written to by: LDAP, KRB5, IPA, AD providers, krb5_child, ldap_child
</li><li><em>New owner and permissions: Both directory and files will be owned by sssd.sssd, the permissions will stay the same</em>
</li></ul><h3 id="SELinuxusermappings">SELinux user mappings</h3>
<ul><li>Filesystem path: <tt>/etc/selinux/targeted/logins</tt>
</li><li>Current owner and permissions: root.root. The directory has permissions of 0755, the files 0644
</li><li>Read by: pam_selinux
</li><li>Written to by: IPA provider
</li><li><em>Change: libsemanage will be used to set the labels instead. Since setting the label is a privileged operation and sssd_be runs unprivileged, setting the label was moved to a separate child process, selinux_child</em>
</li></ul><h3 id="UNIXpipes">UNIX pipes</h3>
<ul><li>Filesystem path: <tt>/var/lib/sss/pipes/</tt>
</li><li>Current owner and permissions: root.root. The directory has permissions of 0755, the files 0666. There is one pipe per responder.
</li><li>Read by: client modules, all responders except InfoPipe
</li><li>Written to by: client modules, responders
</li><li><em>New owner and permissions: Both directory and files will be owned by sssd.sssd, the permissions will stay the same</em>
</li></ul><h3 id="UNIXPAMprivatepipe">UNIX PAM private pipe</h3>
<ul><li>Filesystem path: <tt>/var/lib/sss/pipes/private/pam</tt>
</li><li>Current owner and permissions: root.root. The directory has permissions of 0700, the files 0600. Only the PAM responder uses the private pipe.
</li><li>Read by: PAM responder
</li><li>Written to by: PAM client module
</li><li><em>New owner and permissions: The directory will be owned by sssd.sssd, the file will stay the same</em>
</li></ul><h3 id="DataProviderprivatepipes">Data Provider private pipes</h3>
<ul><li>Filesystem path: <tt>/var/lib/sss/pipes/private/sbus-dp_$domain.$PID</tt>
</li><li>Current owner and permissions: root.root. The directory has permissions of 0700, the files 0600.
</li><li>Read by: Responders
</li><li>Written to by: Data Provider
</li><li><em>New owner and permissions: Both directory and files will be owned by sssd.sssd, the permissions will stay the same</em>
</li></ul><h2 id="Kerberosconfigurationfile">Kerberos configuration file</h2>
<ul><li>Filesystem path: <tt>/etc/krb5.conf</tt>
</li><li>Read by: libkrb5
</li><li>Written to by: The IPA and AD providers "touch" the file in order to make libkrb5 re-read it
</li><li><em>Change: The file can be opened before dropping privileges and we can keep the fd around. Alternatively, the modification can be performed with a setuid helper</em>
</li></ul><h2 id="Configurationchanges">Configuration changes</h2>
<p>
There is a new option called <tt>user</tt> that allows the administrator to
configure the user sssd runs as. Please note that it makes sense to only
use either root or the user sssd was configured with.
</p>
<h2 id="Howtotest">How to test</h2>
<p>
Test ordinary SSSD operations. Everything must work as it used to before. Pay special attention to operations that involve the short-lived processes, like GSSAPI LDAP provider authentication or Kerberos user authentication.
</p>
<p>
Upgrade testing must be performed as well.
</p>
<h2 id="FutureEnhancements">Future Enhancements</h2>
<p>
During the design or implementation, we identified several ideas for
improvement. Even though we don't need to implement these now, it makes
sense to keep the description in this design page for future.
</p>
<h3 id="AllowtheInfoPiperespondertorunassssduser">Allow the InfoPipe responder to run as sssd user</h3>
<p>
In 1.12.3, sssd.conf is still owned by root, mostly because there is a number of programs like
authconfig that generate sssd.conf as root. Moreover, in enterprise setups, the sssd.conf would
be pushed to the client with a tool such as puppet that would still use the same privileges.
</p>
<p>
Therefore, even rootless sssd needs to handle sssd.conf owned by root,
at least for the time being. We can even chown the file to sssd user after startup or
move the write-operation in <a class="missing wiki" href="https://docs.pagure.org/sssd-test2/InfoPipe.html" rel="nofollow">InfoPipe?</a> to a privileged helper.
</p>
<ul><li>Tracked by: <a class="ext-link" href="https://fedorahosted.org/sssd/ticket/2395"><span class="icon">​</span>https://fedorahosted.org/sssd/ticket/2395</a>
</li></ul><h3 id="Allowthecommandlinetoolstorununprivileged">Allow the command line tools to run unprivileged</h3>
<p>
Some command line tools can be run unprivileged - see the section called "Command Line Tools". However, changing them is not a priority as they are short-lived and in general only accept switches, not free-form input.
</p>
<ul><li>Tracked by: <a class="ext-link" href="https://fedorahosted.org/sssd/ticket/2500"><span class="icon">​</span>https://fedorahosted.org/sssd/ticket/2500</a>
</li></ul><h3 id="Splittingthebackendinitializationintoprivilegedandunprivilegedpart">Splitting the back end initialization into privileged and unprivileged part</h3>
<p>
It was proposed on the sssd-devel list that the initialization of the sssd_be process is split
into a privileged and non-privileged function. The back end would open all providers, call the
privileged initialization functions and then drop privileges. Currenly all initialization is
done as root, which is not strictly required in many setups.
</p>
<ul><li>Tracked by: <a class="ext-link" href="https://fedorahosted.org/sssd/ticket/2504"><span class="icon">​</span>https://fedorahosted.org/sssd/ticket/2504</a>
</li></ul><h3 id="UsingKerberosMEMORYcachetoavoidfurtherrestrictrunningKerberoshelpersasroot">Using Kerberos MEMORY cache to avoid further restrict running Kerberos helpers as root</h3>
<p>
Sumit proposed that the keytab is read to a MEMORY type after child process startup so krb5_child
and ldap_child can drop root privileges sooner. There are even some proof-of-concept patches
<a class="ext-link" href="https://lists.fedorahosted.org/pipermail/sssd-devel/2014-November/022403.html"><span class="icon">​</span>on sssd-devel</a>
</p>
<ul><li>Tracked by: <a class="ext-link" href="https://fedorahosted.org/sssd/ticket/2503"><span class="icon">​</span>https://fedorahosted.org/sssd/ticket/2503</a>
</li></ul><h3 id="Usinglibcap-ngtodroptheprivileges">Using libcap-ng to drop the privileges</h3>
<p>
Once we need to not only drop privileges but also retain some capability (CAP_AUDIT comes to mind), we'll need to use something like <a class="ext-link" href="https://people.redhat.com/sgrubb/libcap-ng/"><span class="icon">​</span>libcap-ng</a> instead of handling capabilities ourselves with prctl
</p>
<p>
The downside is obviously the extra dependency, but libcap-ng has a small footprint and is already used by packages that are present on most, if not all, modern Linux installations, such as dbus.
</p>
<p>
We would keep the existing code around as a fallback for environments that don't have the libcap-ngs library available, such as non-Linux systems or embedded systems. Because the code wouldn't be enabled by default, it's important to have unit tests for the privilege drop. For unit testing both options (libcap-ng and our own code), <a class="ext-link" href="http://cwrap.org/uid_wrapper.html"><span class="icon">​</span>uid_wrapper</a> and <a class="ext-link" href="http://cwrap.org/nss_wrapper.html"><span class="icon">​</span>nss_wrapper</a> are the best choice.
</p>
<ul><li>Tracked by: <a class="ext-link" href="https://fedorahosted.org/sssd/ticket/2482"><span class="icon">​</span>https://fedorahosted.org/sssd/ticket/2482</a>
</li></ul><h3 id="Mergetheldap_childandkrb5_childprocesses">Merge the ldap_child and krb5_child processes</h3>
<p>
During design review, it was also proposed to look into merging the
ldap_child and krb5_child as the code performs similar tasks The new
krb5_child would act as an ldap_child based on a command line option value.
</p>
<ul><li>Tracked by: <a class="ext-link" href="https://fedorahosted.org/sssd/ticket/2502"><span class="icon">​</span>https://fedorahosted.org/sssd/ticket/2502</a>
</li></ul><p>
 
</p>
<h2 id="Authors">Authors</h2>
<ul><li>Sumit Bose &lt;<a class="mail-link" href="mailto:sbose@redhat.com"><span class="icon">​</span>sbose@redhat.com</a>&gt;
</li><li>Jakub Hrozek &lt;<a class="mail-link" href="mailto:jhrozek@redhat.com"><span class="icon">​</span>jhrozek@redhat.com</a>&gt;
</li><li>Simo Sorce &lt;<a class="mail-link" href="mailto:simo@redhat.com"><span class="icon">​</span>simo@redhat.com</a>
</li></ul></body></html>