<html><head><link rel="stylesheet" href="/sssd-test2/trac.css" type="text/css" /><link rel="stylesheet" href="/sssd-test2/wiki.css" type="text/css" /></head><body><h1 id="IPAsudoschemasupport">IPA sudo schema support</h1>
<p>
Related ticket(s):
</p>
<ul><li><a class="ext-link" href="https://fedorahosted.org/sssd/ticket/1108"><span class="icon">​</span>https://fedorahosted.org/sssd/ticket/1108</a>
</li></ul><p>
Related design document(s)
</p>
<ul><li><a class="ext-link" href="https://docs.pagure.org/sssd-test2/DesignDocs/SUDOCachingRules.html"><span class="icon">​</span>https://fedorahosted.org/sssd/wiki/DesignDocs/SUDOCachingRules</a>
</li></ul><h2 id="Problemstatement">Problem statement</h2>
<p>
SSSD supports only standard sudo ldap schema at the moment. This has a drawback of having the need to run compat plugin that converts IPA sudo schema into the standard one. Once SSSD has support for IPA schema administrators administrators can disable sudo compat tree which will result in performance improvement on server side.
</p>
<h2 id="Usecases">Use cases</h2>
<ul><li>compat plugin may be disabled when using IPA sudo provider
</li></ul><h2 id="IPAsudoschema">IPA sudo schema</h2>
<p>
IPA sudo schema is rather different than the standard one. This section contains the description of this schema together with ldap containers where sudo rules are stored. A relevant standard attribute is noted when possible. <strong>RDN is marked in bold</strong>. Attributes that hold dn are marked in italic.
</p>
<h4 id="cnsudocmdscnsudodc">cn=sudocmds,cn=sudo,$dc</h4>
<p>
This container contains definition of single commands that may be present in sudo rules.
</p>
<ul><li>objectClass = ipasudocmd
</li><li><strong>ipaUniqueID</strong>
</li><li>sudoCmd ~ sudoCommand
</li><li><em>memberOf</em> (dn of sudo command group)
</li></ul><h4 id="cnsudocmdgroupscnsudodc">cn=sudocmdgroups,cn=sudo,$dc</h4>
<p>
This container contains definition of command groups that may be present in sudo rules.
</p>
<ul><li>objectClass = ipasudocmdgroup
</li><li>ipaUniqueID
</li><li><strong>cn</strong>
</li><li><em>member</em> (dn of sudo command)
</li></ul><h4 id="cnsudorulescnsudodc">cn=sudorules,cn=sudo,$dc</h4>
<p>
This container contains definition of sudo rules.
</p>
<ul><li>objectClass = ipasudorule
</li><li><strong>ipaUniqueID</strong>
</li><li>cn
</li><li>ipaEnabledFlag
</li></ul><ul><li>ipaSudoOpt ~ sudoOption
</li><li><em>ipaSudoRunAs</em> ~ sudoRunAsUser (dn of user or group of users)
</li><li><em>ipaSudoRunAsGroup</em> ~ sudoRunAsGroup (dn of group)
</li><li><em>memberAllowCmd</em> (dn of sudo command or command group)
</li><li><em>memberDenyCmd</em> (dn of sudo command or command group)
</li><li><em>memberHost</em> ~ sudoHost (dn of ipa enrolled machine or hostgroup)
</li><li><em>memberUser</em> ~ sudoUser (dn of user or group of users)
</li><li>hostMask (ip/mask)
</li><li><em>sudoNotAfter</em> ~ sudoNotAfter
</li><li><em>sudoNotBefore</em> ~ sudoNotBefore
</li><li><em>sudoOption</em> ~ sudoOption
</li></ul><p>
The following attibures have a special meaning and can contain only value "all". For example if cmdCategory is present, it is equivalent to sudoCommand=ALL.
</p>
<ul><li>cmdCategory ~ sudoCommand
</li><li>hostCategory ~ sudoHost
</li><li>ipaSudoRunAsGroupCategory ~ sudoRunAsGroup
</li><li>ipaSudoRunAsUserCategory ~ sudoRunAsUser
</li><li>userCategory ~ sudoUser
</li></ul><p>
The following attributes are used to contain external objects not known to IPA nor SSSD. Since SSSD by design provides rules only to users and groups known to it, we can safely ignore those attributes.
</p>
<ul><li>externalHost
</li><li>externalUser
</li><li>ipaSudoRunAsExtGroup
</li><li>ipaSudoRunAsExtUser
</li></ul><h2 id="Overviewofthesolution">Overview of the solution</h2>
<p>
We will again use rules, smart and full refresh similar to what we do in ldap provider. Since we are working with three containers, it is not very simply to translate everything at once into current standard sudo schema that we use inside SSSD, because it would make changes in commands and command groups hard to propagate. Instead we will keep command and command groups stored separately and translate it into sudoCommand in responder on the fly.
</p>
<p>
We will take advantage of using an IPA server and translate dn into names by parsing dn when possible.
</p>
<h2 id="Implementationdetails">Implementation details</h2>
<h4 id="Fullrefresh">Full refresh</h4>
<ul><li>download everything under cn=sudo,$dc that applies to this host
</li><li>store only commands and command groups that are present in at least one rule
</li><li>convert what possible to sudo schema but leave references to commands and command groups for further processing in responder
</li></ul><h4 id="Smartrefresh">Smart refresh</h4>
<ul><li>download everything under cn=sudo,$dc that applies to this host newer than last usn value
</li><li>if new command or command group is downloaded store it only if it is present in changed rule
</li><li>if a rule contains command or command group that is not yet present in sysdb, fetch it with dereference or single lookup
</li></ul><h4 id="Rulesrefresh">Rules refresh</h4>
<ul><li>refresh expired rules and commands and command groups that are present in those rules
</li></ul><h3 id="Configurationchanges">Configuration changes</h3>
<p>
No new options. But we have to provide a way to distinguish between usage of IPA and ldap schema. By default we will use IPA schema and if ldap_sudo_search_base is set to anything else then cn=sudo,$dc we will use the standard sudo ldap schema.
</p>
<h3 id="HowToTest">How To Test</h3>
<ul><li>existing tests can be used, only switching ldap server for IPA
</li></ul><h3 id="Authors">Authors</h3>
<ul><li>Pavel Březina &lt;<a class="mail-link" href="mailto:pbrezina@redhat.com"><span class="icon">​</span>pbrezina@redhat.com</a>&gt;
</li></ul></body></html>