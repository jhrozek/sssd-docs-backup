<html><head><link rel="stylesheet" href="/sssd-test2/trac.css" type="text/css" /><link rel="stylesheet" href="/sssd-test2/wiki.css" type="text/css" /></head><body><h2 id="SUDOpluginAPI">SUDO plugin API</h2>
<p>
Since version 1.8 SUDO supports replacing standard policy behaviour usign plugins.
</p>
<p>
Referral plugin API documentation can be found here: <a class="ext-link" href="http://www.gratisoft.us/sudo/man/1.8.2/sudo_plugin.man.html"><span class="icon">â€‹</span>http://www.gratisoft.us/sudo/man/1.8.2/sudo_plugin.man.html</a>
</p>
<p>
Basically to create a policy plugin, one must define a policy_plugin structure:
</p>
<pre class="wiki">struct policy_plugin {
 #define SUDO_POLICY_PLUGIN    1
     unsigned int type; /* always SUDO_POLICY_PLUGIN */
     unsigned int version; /* always SUDO_API_VERSION */
     int (*open)(unsigned int version, sudo_conv_t conversation,
                 sudo_printf_t plugin_printf, char * const settings[],
                 char * const user_info[], char * const user_env[]);
     void (*close)(int exit_status, int error);
     int (*show_version)(int verbose);
     int (*check_policy)(int argc, char * const argv[],
                         char *env_add[], char **command_info[],
                         char **argv_out[], char **user_env_out[]);
     int (*list)(int argc, char * const argv[], int verbose,
                 const char *list_user);
     int (*validate)(void);
     void (*invalidate)(int remove);
     int (*init_session)(struct passwd *pwd);
 };
</pre><p>
To use the plugin, just edit /etc/sudo.conf:
</p>
<pre class="wiki">Plugin policy_struct_name plugin.so
</pre><p>
Only one policy plugin may be configured.
</p>
<p>
The most important functions are open(), close() and check_policy().
</p>
<h3 id="open">open()</h3>
<p>
Initializes plugin with data passed by SUDO as arguments of this function.
</p>
<h3 id="close">close()</h3>
<p>
Does a data clean up and checks a return code of the command.
</p>
<h3 id="check_policy">check_policy()</h3>
<p>
Determines whether the user can run the command or not. 
</p>
<h2 id="IntegrationinSSSD">Integration in SSSD</h2>
<p>
<a style="padding:0; border:none" href="https://fedorahosted.org/sssd/attachment/wiki/DesignDocs/SUDOIntegration/sudo_highlevel.jpeg"><img src="https://fedorahosted.org/sssd/raw-attachment/wiki/DesignDocs/SUDOIntegration/sudo_highlevel.jpeg" alt="High level view of integration" title="High level view of integration" /></a>
</p>
<h2 id="SSSDSUDOplugin">SSSD SUDO plugin</h2>
<p>
All decision logic is done by responder and therefore this plugin should be as light weight as possible.
</p>
<p>
Communication with responder is done by SSS CLI sockets interface.
</p>
<p>
<a style="padding:0; border:none" href="https://fedorahosted.org/sssd/attachment/wiki/DesignDocs/SUDOIntegration/sudo_plugin.png"><img src="https://fedorahosted.org/sssd/raw-attachment/wiki/DesignDocs/SUDOIntegration/sudo_plugin.png" alt="SSSD SUDO plugin" title="SSSD SUDO plugin" /></a>
</p>
<h2 id="SSSDSUDOresponder">SSSD SUDO responder</h2>
<h2 id="Pluginresponderprotocol">Plugin &lt;=&gt; responder protocol</h2>
<h3 id="Query">Query</h3>
<p>
Byte array with format:
</p>
<pre class="wiki">qualified_command_path\0argv[0]\0argv[i]\0\0env_add\0\0user_env\0\0settings\0\0user_info\0\0
</pre><p>
where env_add, user_env, settings and user_info are in the form of NAME=VALUE pairs.
</p>
<p>
All fields are interpreted as char*.
</p>
<p>
<strong>qualified_command_path</strong> is a full name of executed command (/bin/ls, ./my-program)
</p>
<p>
<strong>argv[]</strong> arguments passed to executed programs
</p>
<p>
<strong>env_add</strong> environment variables that user wants to add
</p>
<p>
<strong>user_env</strong> current environment variables (provided in open() function by SUDO)
</p>
<p>
<strong>settings</strong> provided in open() function by SUDO (see plugin API open())
</p>
<p>
<strong>user_info</strong> provided in open() function by SUDO (see plugin API open())
</p>
<h3 id="Reponse">Reponse</h3>
<p>
Byte array with format:
</p>
<pre class="wiki">(result)argv\0\0command_info\0\0user_env\0\0
</pre><p>
where command_info and user_env are in the form of NAME=VALUE pairs.
</p>
<p>
All fields except result are interpreted as char*.
</p>
<p>
<strong>result</strong> interpreted as an integer value
</p>
<p>
<strong>argv[]</strong> arguments passed to executed programs
</p>
<p>
<strong>command_info</strong> information about the command (see plugin API check_policy())
</p>
<p>
<strong>user_env</strong> environment variables that should be kept / added.
</p>
</body></html>