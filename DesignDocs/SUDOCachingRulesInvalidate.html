<html><head><link rel="stylesheet" href="/sssd-test2/trac.css" type="text/css" /><link rel="stylesheet" href="/sssd-test2/wiki.css" type="text/css" /></head><body><h1 id="InvalidateCachedSUDORules">Invalidate Cached SUDO Rules</h1>
<p>
Related ticket(s):
</p>
<ul><li><a class="ext-link" href="https://fedorahosted.org/sssd/ticket/2081"><span class="icon">​</span>https://fedorahosted.org/sssd/ticket/2081</a>
</li><li><a class="ext-link" href="https://fedorahosted.org/sssd/ticket/2884"><span class="icon">​</span>https://fedorahosted.org/sssd/ticket/2884</a>
</li></ul><h3 id="Problemstatement">Problem statement</h3>
<p>
Currently sss_cache can't be used to reliably invalidate sudo rules.
</p>
<h3 id="Usecases">Use cases</h3>
<p>
Usually if admin changes sudo rules he would like to see an effect immediately.
</p>
<h3 id="Overviewofthesolution">Overview of the solution</h3>
<p>
Sudo rules are stored in sss_cache. Sometimes <em>smart</em> or <em>full</em> refresh of sudo rules is done, but there is no effective way to invalidate them (see <a class="ext-link" href="https://docs.pagure.org/sssd-test2/DesignDocs/SUDOCachingRules.html"><span class="icon">​</span>https://fedorahosted.org/sssd/wiki/DesignDocs/SUDOCachingRules</a>).
</p>
<p>
Solution consists of two steps:
</p>
<ol><li>Invalidate sudo rules by setting expiration time to 0 which can prevent to use old rules. 
</li><li>Trigger full refresh (and maybe even smart refresh) on demand.
</li></ol><h3 id="Implementationdetails">Implementation details</h3>
<h4 id="Invalidatingsudorules">Invalidating sudo rules</h4>
<p>
SSSD provides tool sss_cache for invalidating items.
</p>
<pre class="wiki">$ sss_cache --help
Usage: sss_cache [OPTION...]
  -E, --everything            Invalidate all cached entries except for sudo rules
  -u, --user=STRING           Invalidate particular user
  -U, --users                 Invalidate all users
  -g, --group=STRING          Invalidate particular group
  -G, --groups                Invalidate all groups
  -n, --netgroup=STRING       Invalidate particular netgroup
  -N, --netgroups             Invalidate all netgroups
  -s, --service=STRING        Invalidate particular service
  -S, --services              Invalidate all services
  -a, --autofs-map=STRING     Invalidate particular autofs map
  -A, --autofs-maps           Invalidate all autofs maps
  -h, --ssh-host=STRING       Invalidate particular SSH host
  -H, --ssh-hosts             Invalidate all SSH hosts
  -d, --domain=STRING         Only invalidate entries from a particular domain

Help options:
  -?, --help                  Show this help message
      --usage                 Display brief usage message
</pre><p>
We need:
</p>
<ul><li>add option <tt>--sudo-rule=STRING</tt> for invalidating only STRING named sudo rule,
</li><li>add option <tt>--sudo-rules</tt> for invalidating all sudo rules,
</li><li>change option <tt>--everything</tt> for invalidating sudo rules too.
</li></ul><p>
For those changes we will provide new function <tt>sysdb_search_sudo_rule()</tt> in <tt>db/sysdb_sudo.{hc}</tt>.
</p>
<div class="code"><pre>errno_t
sysdb_search_sudo_rules<span class="p">(</span>TALLOC_CTX <span class="o">*</span>mem_ctx<span class="p">,</span>
                        <span class="k">struct</span> sss_domain_info <span class="o">*</span>domain<span class="p">,</span>
                        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span>filter<span class="p">,</span>
                        <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span>attrs<span class="p">,</span>
                        size_t <span class="o">*</span>num_hosts<span class="p">,</span>
                        <span class="k">struct</span> ldb_message <span class="o">***</span>hosts<span class="p">)</span>
<span class="cm">/* Synopsis is inspired by other `sysdb_search_*()` functions. */</span>
</pre></div><p>
This new function be able to find sudo rule by given name (via filter).
</p>
<p>
On the other hand there is function <tt>sudosrv_get_sudorules_query_cache()</tt> in <tt>responder/sudo/sudosrv_get_sudorules.c</tt> which has very similar behavior. Maybe it is candidate for proxy and moving to <tt>db/sysdb_sudo.{hc}</tt>.
</p>
<hr />
<h2 id="ToBeDone">To Be Done</h2>
<p>
 
</p>
<h3 id="Implementationdetails1">Implementation details</h3>
<p>
A more technical extension of the previous section. Might include low-level details, such as C structures, function synopsis etc. In case of very trivial features (e.g a new option), this section can be merged with the previous one.
</p>
<h3 id="Configurationchanges">Configuration changes</h3>
<p>
Does your feature involve changes to configuration, like new options or options changing values? Summarize them here. There's no need to go into too many details, that's what man pages are for.
</p>
<h3 id="HowToTest">How To Test</h3>
<p>
This section should explain to a person with admin-level of SSSD understanding how this change affects run time behaviour of SSSD and how can an SSSD user test this change. If the feature is internal-only, please list what areas of SSSD are affected so that testers know where to focus.
</p>
<h3 id="Authors">Authors</h3>
<p>
Give credit to authors of the design in this section.
</p>
</body></html>