<html><head><link rel="stylesheet" href="/sssd-test2/trac.css" type="text/css" /><link rel="stylesheet" href="/sssd-test2/wiki.css" type="text/css" /></head><body><h2 id="SudoResponderCacheBehavior">Sudo <a class="missing wiki" href="https://docs.pagure.org/sssd-test2/Responder/Cache.html" rel="nofollow">Responder/Cache?</a> Behavior</h2>
<blockquote>
<p>
Before we go into the caching its better to know some useful information about sudo schema.
</p>
</blockquote>
<blockquote>
<blockquote>
<p>
1) As the document at <a class="ext-link" href="http://www.gratisoft.us/sudo/man/1.8.1/sudoers.ldap.man.html"><span class="icon">​</span>http://www.gratisoft.us/sudo/man/1.8.1/sudoers.ldap.man.html</a> indicates the sudo rules are contained in a ldap server inside the SUDOers container.<br />
</p>
</blockquote>
</blockquote>
<blockquote>
<blockquote>
<p>
2) The SUDOers container contains the sudoRole objects. Where each object indicates a a sudorule.<br />
</p>
</blockquote>
</blockquote>
<blockquote>
<blockquote>
<p>
3) Each sudoRole object supports following attributes.<br /><br />
</p>
</blockquote>
</blockquote>
<p>
<br />
</p>
<blockquote>
<p>
<strong>sudoUser</strong> - A user name, uid (prefixed with '#'), Unix group (prefixed with a '%') or user netgroup (prefixed with a '+').<br />
</p>
</blockquote>
<blockquote>
<p>
<strong>sudoHost</strong> - A host name, IP address, IP network, or host netgroup (prefixed with  a '+'). The special value ALL will match any host.<br />
</p>
</blockquote>
<blockquote>
<p>
<strong>sudoCommand</strong> - A Unix command with optional command line arguments and wild chars.<br />
</p>
</blockquote>
<blockquote>
<p>
<strong>sudoOption</strong> – Specifies options to be enabled or disabled as in the sudoers file.<br />
</p>
</blockquote>
<blockquote>
<p>
<strong>sudoRunAsUser</strong> - A user name or uid (prefixed with '#') that commands may be run as or a Unix group (prefixed with a '%') or user netgroup (prefixed with a '+') that contains a list of users that commands may be run as. The special value ALL will match any user.<br />
</p>
</blockquote>
<blockquote>
<p>
<strong>sudoRunAsGroup</strong> - A Unix group or gid (prefixed with '#') that commands may be run as. The special value ALL will match any group.<br />
</p>
</blockquote>
<blockquote>
<p>
<strong>sudoNotBefore</strong> - A time-stamp in the form yyyymmddHHMMZ that can be used to provide a start date/time for when the sudoRole will be valid. If multiplesudoNotBefore entries are present, the earliest is used. Note that timestamps must be in Coordinated Universal Time (UTC), not the local timezone.<br />
</p>
</blockquote>
<blockquote>
<p>
<strong>sudoNotAfter</strong> - A time stamp in the form yyyymmddHHMMZ that indicates an expiration date/time,after which the sudoRole will no longer be valid. If multiplesudoNotBefore entries are present, the last one is used. Note that time-stamps must be in Coordinated Universal Time (UTC), not the local timezone<br />
</p>
</blockquote>
<blockquote>
<p>
<strong>*To use <a class="missing wiki" href="https://docs.pagure.org/sssd-test2/SudoNotBefore.html" rel="nofollow">SudoNotBefore?</a> and <a class="missing wiki" href="https://docs.pagure.org/sssd-test2/SudoNotAfter.html" rel="nofollow">SudoNotAfter?</a>, the user should enable the SUDOERS_TIMED option in the config file.</strong>*
</p>
</blockquote>
<blockquote>
<blockquote>
<p>
<strong>sudoOrder</strong> - The sudoRole entries retrieved from the LDAP directory have no inherent order. The sudoOrder attribute is an integer (or floating point value for LDAP servers that support it) that is used to sort the matching entries. This allows LDAP-based sudoers entries to more closely mimic the behaviour of the sudoers file, where the of the entries influences the result. If multiple entries match, the entry with the highest sudoOrder attribute is chosen. 
</p>
</blockquote>
<p>
<strong>*A sudoRole must contain at least one sudoUser, sudoHost and sudoCommand.</strong>*<br />
</p>
</blockquote>
<blockquote>
<blockquote>
<p>
4)The sudoRole that have <tt>'''cn=Defaults'''</tt> will be applied (if specified) over all the rules before applying any other rules. This mimics the default statements in the sudoers file.        
</p>
</blockquote>
</blockquote>
<p>
Now we have the necessary information to move on.
</p>
<p>
Q1). <strong>What should we cache for offline sudo authentication???</strong>
</p>
<p>
The anatomy of sudo is as follows.
</p>
<blockquote>
<p>
when you type 'sudo cmd' sudo is going to lookup in ldap to try and find the user posix groups and the user/host Nisnetgroup where the user is a member.  Then it is going to do an ldap search in the ou=SUDOers container looking for any rule that matches that user or his usergroups.  when it matches some rules, it goes down that list to see if the hostname OR a netgroup that the host is a member of is in that same rule, then finally it determines if the command 'less' is allowed. 
</p>
</blockquote>
<blockquote>
<p>
This is how it works in a ldap server client. But in order to incorporate the netgroups we have to do some hack in the order of this anatomy.
</p>
</blockquote>
<blockquote>
<p>
For the successful validation we need to know the nisnetgroups and posix groups that a user/host is a member of. So that we need to cache the host/user-&gt; nisgroup and user-&gt;posixgroups along with all sudoRole objects inside the SUDOers container that references to the specified command.
</p>
</blockquote>
<blockquote>
<p>
The simple solution for this problem is to enumerate all groups and netgroup information and check it with sudorules. But this approach less efficient and costly. Instead of enumerating all the rules, the procedure goes like this.
</p>
</blockquote>
<blockquote>
<p>
1) First we need to find the groups and user/host netgroups in which the user is a member of. That is the first step. We can do the search in DN: cn=accounts,dc=example,dc=com. Here we can use memberof plugin to resolve the user groups and the host groups. This step is already implemented inside the sssd. In order to include the support for nis net groups we can add one more filter to the query that searches for the user groups. The query is
</p>
</blockquote>
<pre class="wiki">(| 
   (nisNetgroupTriple=\28*,username,*\29) 
   (nisNetgroupTriple=\28hostname,*,*\29) 
)
</pre><blockquote>
<p>
This will give you the netgroup that the user/host is a member of.
</p>
</blockquote>
<blockquote>
<blockquote>
<p>
2) In the second phase we apply the search to filter the rules that applies to the user/host posix groups and netgroups found in step1. Search returns  (|(sudoBaseCommand=cmd)(sudoCommand=ALL)) where the sudoBaseCommand is JUST the command (not including args).
</p>
</blockquote>
</blockquote>
<p>
The skeleton of the filter will be:
</p>
<pre class="wiki">(&amp;
    (objectClass=sudoRole)
    (|
        (sudoUser=username)      
        (sudoUser=#uid)      
        (sudoUser=%usergroup1)
        (sudoUser=%usergroupN)   
        (sudoUser=+userNetgroup1)
        (sudoUser=+userNetgroupN)        
        (sudoUser=ALL)
    )
    (|
        (sudoHost=ipa.example.com)
        (sudoHost=+sample_host_group)
        (sudoHost=ALL)
    )
    (|
        (sudoBaseCommand=!cmd*)
        (sudoCommand=ALL)
    )  
 )
</pre><blockquote>
<p>
3)From these rules the evaluation is done.
</p>
</blockquote>
<blockquote>
<blockquote>
<p>
Performance Considerations
--------------------------------------
</p>
</blockquote>
</blockquote>
<blockquote>
<blockquote>
<p>
1)Within a sudoRole, The sudoCommand attribute with an command negation is executed first, then sudoCommand with exact command is evaluated, at last the sudoCommands with 'all' is evaluated.
2) To incorporate the sudoOrder attribute  we can do the sorting AFTER our search filter. So we'll limit the number of rules to sort first.
</p>
</blockquote>
</blockquote>
<p>
Q2) How to store cached data???
The cached data is in the LDAP format. So that the simple option available is to store it in the ldb file.
</p>
</body></html>