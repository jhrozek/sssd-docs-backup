<html><head><link rel="stylesheet" href="/sssd-test2/trac.css" type="text/css" /><link rel="stylesheet" href="/sssd-test2/wiki.css" type="text/css" /></head><body><h1 id="FixDNSsiteaclientisusing">Fix DNS site a client is using</h1>
<p>
Related ticket(s):
</p>
<ul><li><a class="ext-link" href="https://fedorahosted.org/sssd/ticket/2486"><span class="icon">​</span>https://fedorahosted.org/sssd/ticket/2486</a>
</li></ul><h3 id="Problemstatement">Problem statement</h3>
<p>
Even though the Active Directory provider is able to leverage DNS sites, the
site discovery is always automatic. There is no way to <tt>pin</tt> a particular
client into a particular site. This design document describes a way to do so.
</p>
<h3 id="Usecases">Use cases</h3>
<p>
The site discovery relies on client being part of subnet. It is not
always practical or even possible to assign Linux machines to the right
subnet. Still, these clients should be able to leverage the nearest AD site,
even at the expense of manual configuration in <tt>sssd.conf</tt>.
</p>
<h3 id="Overviewofthesolution">Overview of the solution</h3>
<p>
The SSSD will gain a new AD provider option that would, if AD sites are
enabled, override any dynamically discovered sites. This option would pin
the client to a particular site not only for primary domain but also for
subdomains. The discovery search would only be used to find the forest we
are enrolled with.
</p>
<p>
For Global Catalog service discovery of the primary and secondary domains would then be defined as follows:
</p>
<ul><li>primary domain - <tt>$HARDCODED_SITE._sites.$FOREST</tt>
</li><li>backup domain - <tt>$FOREST</tt>
</li></ul><p>
For pure LDAP searches, the domains would then be defined as:
</p>
<ul><li>primary domain - <tt>$HARDCODED_SITE._sites.$DOMAIN</tt>
</li><li>backup domain - <tt>$DOMAIN</tt>
</li></ul><p>
Above, $FOREST is auto-discovered and $DOMAIN is either the SSSD domain name
as defined in the config file (for the main SSSD domain) or autodiscovered
from object of class <tt>trustedDomain</tt>.
</p>
<p>
In both cases, the full DNS search consists of <tt>_$service._$port.$domain</tt>.
</p>
<p>
Especially for trusted domains, the overridden search domain might not
return anything, but the DNS resolver code is built such that it iterates
over search domains until the search yields some result.
</p>
<h3 id="Authenticationagainsttrusteddomains">Authentication against trusted domains</h3>
<p>
For trusted domains, we currently always talk to a local DC which
gives libkrb5 a referral to a trusted-domain specific DC that handles
authentication against a KDC from the trusted domain. This process is
completely opaque to SSSD, which means that Kerberos authentication doesn't
take the sites into account at all.
</p>
<h3 id="Implementationdetails">Implementation details</h3>
<p>
The SSSD AD provider would gain a new option called <tt>ad_site</tt>. This
option would be unset by default.
</p>
<p>
The SRV initialization function <tt>ad_srv_plugin_ctx_init()</tt> needs
to be adjusted to accept a site override as a <tt>const char *site_override</tt> since
the site name is just a string. In the default case, where the
option is unset, this option would be set to NULL. In any case, the
<tt>ad_get_client_site_send()/recv()</tt> request would run to completion since we
need to learn the forest name anyway. If the new option is set, then the
caller of <tt>ad_get_client_site_recv()</tt> would still read the forest value,
but ignore the site value and use the value of the <tt>ad_site</tt>
option instead.
</p>
<h3 id="Configurationchanges">Configuration changes</h3>
<p>
A new option <tt>ad_site</tt> as described above. The option would be both described in man pages and implemented in the configAPI.
</p>
<h3 id="HowToTest">How To Test</h3>
<p>
The best testing would be performed using an AD test environment consisting
of at least two servers in the same domain. To test, join both DCs to the
same domain. Create two sites such that the IP address of your SSSD client
would set you in one of them.
</p>
<p>
Make sure that, by default, SSSD creates the kdcinfo file using the DC in the
autodetected site and authenticates you against the DCs from the autodetected
site. The latter can be verified using i.e. tcpdump and krb5_child log files.
</p>
<p>
Set the <tt>ad_site</tt> option to a non-default site. Verify, using
tcpdump, kdcinfo file contents and SSSD debug logs that SSSD redirects
communication to DCs in the non-default site.
</p>
<h3 id="Authors">Authors</h3>
<ul><li>Jakub Hrozek &lt;<a class="mail-link" href="mailto:jhrozek@redhat.com"><span class="icon">​</span>jhrozek@redhat.com</a>&gt;
</li></ul></body></html>