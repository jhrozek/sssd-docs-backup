<html><head><link rel="stylesheet" href="/sssd-test2/trac.css" type="text/css" /><link rel="stylesheet" href="/sssd-test2/wiki.css" type="text/css" /></head><body><h1 id="Smartcardauthentication-Step1localauthentication">Smartcard authentication - Step 1 (local authentication)</h1>
<p>
Related ticket(s):
</p>
<ul><li><a class="ext-link" href="https://fedorahosted.org/sssd/ticket/546"><span class="icon">​</span>https://fedorahosted.org/sssd/ticket/546</a>
</li><li><a class="ext-link" href="https://fedorahosted.org/sssd/ticket/2711"><span class="icon">​</span>https://fedorahosted.org/sssd/ticket/2711</a>
</li></ul><h3 id="Problemstatement">Problem statement</h3>
<p>
Smartcard based authentication is another alternative to password based authentication. Other than OTP tokens where all authentication data can be entered at a password prompt Smartcards require special hardware and software to access the credentials stored on the card.
</p>
<p>
Currently solutions are based on the pam_pkcs11 module which e.g. requires special configuration to map the certificate stored on a Smartcard to a user. Since SSSD already can map certificates to users (see e.g. <a class="missing wiki" href="https://docs.pagure.org/sssd-test2/LookupUsersByCertificate.html" rel="nofollow">LookupUsersByCertificate?</a>) integration would be much easier. Additionally features like different authentication types per user or per service would only be possible with SSSD.
</p>
<h3 id="Usecases">Use cases</h3>
<h4 id="Localauthentication">Local authentication</h4>
<p>
If there is a Smartcard reader connected to a system the user can authenticate to the system by placing his smartcard into the reader, give his name (might not be needed in some cases) and the Smartcard PIN at the login prompt and is authenticated successfully if the certificate on the Smartcard is valid and satisfies other, configurable criteria. This includes authentication at a text or graphical console but local services like <em>su</em> and <em>sudo</em> as well.
</p>
<h4 id="Remoteauthenticationwithssh">Remote authentication with ssh</h4>
<p>
To avoid password authentication ssh supports public-private key based authentication from the beginning. Since the certificates on the Smartcard are stored together with the PIN protected private key this key material can be used for ssh authentication as well. On the client side a ssh client program is needed which is able to access the Smartcard. On the server side only the public key from the certificate is needed in a suitable format for ssh. With the help of the <em>sss_ssh_authorized_keys</em> utility SSSD can make this information available to the sshd running on the server if the certificate is stored together with the other user data in a central storage, e.g. LDAP.
</p>
<h3 id="Overviewofthesolution">Overview of the solution</h3>
<h3 id="Implementationdetails">Implementation details</h3>
<h3 id="Configurationchanges">Configuration changes</h3>
<p>
To enable certificate based authentication in SSSD <em>pam_cert_auth</em> must be set to <em>True</em> in the <em>[pam]</em> section of <em>sssd.conf</em>.
</p>
<p>
Additional option to tune e.g. the certificate validation will be added later. 
</p>
<h3 id="Howtotest">How to test</h3>
<p>
In the following it is assumed that SSSD is running on an IPA client. 
</p>
<h4 id="Hardwarereaderandcard">Hardware reader and card</h4>
<h5 id="ConfiguringIPAclientforlocalauthenticationwithaSmartcard">Configuring IPA client for local authentication with a Smartcard</h5>
<p>
The most easy way to test is with a Smartcard reader and a Smartcard. If the Smartcard reader is supported by the <em>coolkey</em> package the needed PKCS<a class="closed ticket" href="https://fedorahosted.org/sssd/ticket/11" title="defect: Implement auto-reconnection of the PAM Responder to the Data Provider (closed: fixed)">#11</a> modules is already added to the central NSS database at /etc/pki/nssdb during the installation of the package. In case a different PKCS<a class="closed ticket" href="https://fedorahosted.org/sssd/ticket/11" title="defect: Implement auto-reconnection of the PAM Responder to the Data Provider (closed: fixed)">#11</a> module is needed it can be added with modutil
</p>
<pre class="wiki">modutil modutil -dbdir /etc/pki/nssdb -add "My PKCS#11 modules" -libfile libmypkcs11.so
</pre><p>
(if the PKCS<a class="closed ticket" href="https://fedorahosted.org/sssd/ticket/11" title="defect: Implement auto-reconnection of the PAM Responder to the Data Provider (closed: fixed)">#11</a> modules in not in the default library search path and full path is needed).
</p>
<p>
Now <em>certutil</em> should ask for a PIN and show your certificate, if the reader is connected and the card is in
</p>
<pre class="wiki">certutil -L -d /etc/pki/nssdb -h all
</pre><p>
Most probably the certificate on the card is currently not assigned to an IPA user. To do this the certificate can be extracted with
</p>
<pre class="wiki">certutil -L -d /etc/pki/nssdb -n 'Certificate Nick-Name' -a
</pre><p>
which will dump the PEM encoded certificate. Since the <em>ipa</em> utility expected the base64 string from the PEM encoding in a single line 
</p>
<pre class="wiki">certutil -L -d /etc/pki/nssdb -n 'Certificate Nick-Name' -a | grep -v -- '----' |tr -d '[\n\r]'
</pre><p>
will dump it in a single line. Now <em>ipa user-mod username --certificate=MIIE......</em> can be used to load the certificate into the user entry. Please note that the --certificate option is only available with FreeIPA 4.2 or later.
</p>
<p>
If <em>pam_cert_auth = True</em> in the <em>[pam]</em> section of <em>sssd.conf</em>, the card is inserted in the reader and the certificate loaded in the user entry e.g. the console login prompt should now ask for a PIN instead of a password and if the correct PIN is entered the user should be successfully authenticated and logged in.
</p>
<h5 id="RunnningasshclientwithSmartcardsupport">Runnning a ssh client with Smartcard support</h5>
<p>
The <em>ssh</em> client program distributed with Fedora or RHEL contains patches which add Smartcard support to the utility. To activate it the needed PKCS<a class="closed ticket" href="https://fedorahosted.org/sssd/ticket/11" title="defect: Implement auto-reconnection of the PAM Responder to the Data Provider (closed: fixed)">#11</a> module to talk to the Smartcard reader has to be made available with the <em>-I</em> option
</p>
<pre class="wiki">ssh -I /usr/lib/libmypkcs11.so -l ipauser ipahost.ipa.domain
</pre><p>
where the certificate has to be added to the IPA user entry as described above.
</p>
<h4 id="Softwarecertificateswithlibsoftokn3.so">Software certificates with libsoftokn3.so</h4>
<p>
First a certificate together with the private key is needed. Instructions how to create certificates with FreeIPA can e.g. be found at <a class="ext-link" href="http://www.freeipa.org/page/PKI"><span class="icon">​</span>http://www.freeipa.org/page/PKI</a>. Please store the certificate in a NSS database. Since in this this first step the user is looked up with the help of the full certificate any certificate valid for client authentication can be used. This means instead of creating a new one an existing certificate can be used. <strong>Please do this only in test environment which will be discarded afterwards. Copying certificates from a production environment is a security breach.</strong>
</p>
<h5 id="ConfiguringIPAclientforlocalauthenticationwithaSmartcard1">Configuring IPA client for local authentication with a Smartcard</h5>
<p>
Like in the case with a hardware reader a PKCS<a class="closed ticket" href="https://fedorahosted.org/sssd/ticket/11" title="defect: Implement auto-reconnection of the PAM Responder to the Data Provider (closed: fixed)">#11</a> module to access the certificate in the NSS DB must be added to the systems NSS DB in /etc/pki/nssdb. The PKCS<a class="closed ticket" href="https://fedorahosted.org/sssd/ticket/11" title="defect: Implement auto-reconnection of the PAM Responder to the Data Provider (closed: fixed)">#11</a> module for accessing certificates and private keys in a NSS database is <em>libsoftokn3.so</em>. But unfortunately this module needs some configuration option when loaded. Although I guess <em>modutil</em> should work as well I was only able to add the needed parameters with <em>pk11install</em> from the coolkey package. In the following we assume that the certificate and the private key is stored in an NSS DB called <em>my_cert</em> in the home directory of the user.
</p>
<pre class="wiki">pk11install -i -v -p /etc/pki/nssdb 'name=soft parameters="configdir=sql:/home/use/my_cert dbSlotDescription=\"My Slot\" dbTokenDescription=\"My Token\"" library=/usr/lib/libsoftokn3.so'
</pre><p>
If <em>pam_cert_auth = True</em> in the <em>[pam]</em> section of <em>sssd.conf</em>, and the certificate loaded in the user entry e.g. the console login prompt should now ask for a PIN instead of a password and if the correct PIN is entered the user should be successfully authenticated and logged in.
</p>
<h5 id="RunningsshclientwithSmartcardsupport">Running ssh client with Smartcard support</h5>
<p>
The PKCS<a class="closed ticket" href="https://fedorahosted.org/sssd/ticket/11" title="defect: Implement auto-reconnection of the PAM Responder to the Data Provider (closed: fixed)">#11</a> module for accessing certificates and private keys in a NSS database is <em>libsoftokn3.so</em>. But unfortunately this modules needs some configuration option when loaded and there is (afaik) currently no way to pass them with the <em>ssh</em> command. Luckily there is p11-kit which can be used to load <em>libsoftokn3.so</em> with options. In the following we assume that the certificate and the private key is stored in an NSS DB call <em>my_cert</em> in the home directory of the user.
</p>
<p>
To configure p11-kit make sure <em>~/.config/pkcs11</em> and <em>~/.config/pkcs11/modules</em> exists and create the following two files:
</p>
<pre class="wiki">cat &gt; ~/.config/pkcs11/pkcs11.conf &lt;&lt; EOF_EOF
user-config: only
EOF_EOF
</pre><pre class="wiki">cat &gt; ~/.config/pkcs11/modules/my_cert.module &lt;&lt; EOF_EOF
module: /usr/lib/libsoftokn3.so
x-init-reserved: configdir='sql:/home/user/my_cert'
critical: yes
EOF_EOF
</pre><p>
On 64bit systems you have to use <em>/usr/lib64/libsoftokn3.so</em>.
</p>
<p>
Now <em>ssh</em> can be called with <em>/usr/lib/p11-kit-proxy.so</em> (or the 64bit version)
</p>
<pre class="wiki">ssh -I /usr/lib/p11-kit-proxy.so -l ipauser ipahost.ipa.domain
</pre><h4 id="Softwarecertificateswithlibsofthsm2.so">Software certificates with libsofthsm2.so</h4>
<p>
Since the <em>libsoftokn3.so</em> PKCS<a class="closed ticket" href="https://fedorahosted.org/sssd/ticket/11" title="defect: Implement auto-reconnection of the PAM Responder to the Data Provider (closed: fixed)">#11</a> module requires additional configuration which most consumers like the <em>ssh</em> client (see above) or <em>kinit</em> do not support and the workaround with <em>p11-kit-proxy.so</em> might not always be possible the following section will show how the <em>libsofthsm2.so</em> PKCS<a class="closed ticket" href="https://fedorahosted.org/sssd/ticket/11" title="defect: Implement auto-reconnection of the PAM Responder to the Data Provider (closed: fixed)">#11</a> module from the <a class="ext-link" href="http://www.opendnssec.org/"><span class="icon">​</span>OpenDNSSEC</a> project can be used. As above we assume that the certificate and the corresponding private key are available.
</p>
<h3 id="Authors">Authors</h3>
<ul><li>Sumit Bose &lt;<a class="mail-link" href="mailto:sbose@redhat.com"><span class="icon">​</span>sbose@redhat.com</a>&gt;
</li></ul></body></html>