<html><head><link rel="stylesheet" href="/sssd-test2/trac.css" type="text/css" /><link rel="stylesheet" href="/sssd-test2/wiki.css" type="text/css" /></head><body><h1 id="LookupUsersbyCertificate-ActiveDirectory">Lookup Users by Certificate - Active Directory</h1>
<p>
Related ticket(s):
</p>
<ul><li><a class="ext-link" href="https://fedorahosted.org/sssd/ticket/2897"><span class="icon">​</span>https://fedorahosted.org/sssd/ticket/2897</a>
</li></ul><h3 id="Problemstatement">Problem statement</h3>
<p>
So far the main focus of the SSSD certificate and Smartcard authentication support in SSSD was on FreeIPA. Although it is possible to use it with the AD provider as well (see <a class="ext-link" href="https://docs.pagure.org/sssd-test2/DesignDocs/SmartcardAuthenticationTestingWithAD.html"><span class="icon">​</span>SmartcardAuthenticationTestingWithAD</a> for details) it requires some manual configuration.
</p>
<p>
On this page we describe the enhanced support for certificates in AD and in override data for the direct (AD provider) and indirect (IPA with trust to AD) integration.
</p>
<h3 id="Usecases">Use cases</h3>
<h4 id="Apache">Apache</h4>
<p>
Apache is using <em>mod_lookup_identity</em> to look up a user who used certificate based authentication with the help of the certificate. Currently, without additional configuration, only IPA users were supported. Now users from AD which have the certificate stored in the user entry as supported as well for both direct and indirect integration. Additionally certificates can be stored in local overrides for the direct integration and in IPA server-side overrides for the indirect integration.
</p>
<h4 id="Smartcardauthentication">Smartcard authentication</h4>
<p>
If the certificate of the user is stored in the user's entry in AD or in a IPA or local override the user can authenticate with a Smartcard which holds the certificate and the matching private key.
</p>
<p>
Since both use-case rely in the same common code only the user lookup is discussed later on because it is easier to test and validate.
</p>
<h3 id="Overviewofthesolution">Overview of the solution</h3>
<h4 id="General">General</h4>
<p>
The common override lookup code must be enhanced to allow lookups by certificates as well.
</p>
<h4 id="ADproviderdirectintegration">AD provider (direct integration)</h4>
<p>
To support the direct integration 
</p>
<ul><li>the attribute containing the certificate must be read by default 
</li><li>sss_override must be enhanced to store certificates in local overrides as well
</li></ul><h4 id="IPAproviderindirectintegration">IPA provider (indirect integration)</h4>
<p>
To support the indirect integration
</p>
<ul><li>the IPA override lookup code must be enhanced to read certificate overrides from the server and store them in the cache
</li><li>the IPA client code to look up AD users via the extdom plugin must be enhanced to allow lookups by certificates
</li></ul><h4 id="SupportfortheIPAextdomplugin">Support for the IPA extdom plugin</h4>
<p>
Currently it is only possible to look up users by certificate with the <a class="missing wiki" href="https://docs.pagure.org/sssd-test2/InfoPipe.html" rel="nofollow">InfoPipe?</a> which uses DBus. To avoid to add a DBus requirement to the extdom plugin and the directory server a call similar to sss_nss_getnamebysid() should be added to allow easy lookups by certificate via the NSS responder.
</p>
<h3 id="Implementationdetails">Implementation details</h3>
<p>
Most of the changes are related to adding the new attribute to the various lookup requests.
</p>
<h3 id="Configurationchanges">Configuration changes</h3>
<p>
For the AD provider the currently unset option <em>ldap_user_certificate</em> will be set to <em>userCertificate;binary</em>. This means that is a certificate is available in the user entry it will be downloaded and written to the cache by default. To avoid this <em>ldap_user_certificate</em> must be set to a non-existing attribute name like e.g.
</p>
<pre class="wiki">ldap_user_certificate = nonExistingAttributeName
</pre><p>
The <em>sss_override user-add</em> utility has a new option <em>--certificate</em> (<em>-x</em>) which expects the base64-endode certificate as an argument.
</p>
<h3 id="HowToTest">How To Test</h3>
<p>
Testing can be done with <em>dbus-send</em> as described in <a class="missing wiki" href="https://docs.pagure.org/sssd-test2/LookupUsersByCertificate.html" rel="nofollow">LookupUsersByCertificate?</a>. Instead of storing the certificate in the user object of an IPA user it should be now stored in the user object of an AD user as e.g. described in <a class="ext-link" href="https://docs.pagure.org/sssd-test2/DesignDocs/SmartcardAuthenticationTestingWithAD.html#WritingthecertificatetoAD"><span class="icon">​</span>WritingthecertificatetoAD</a>. Additionally certificates overrides can be written with the <em>sss_override</em> utility for the direct integration or the <em>ipa idoverrideuser_add_cert</em> command for the indirect integration.
</p>
<p>
If multiple certificate are added it should be noted that a user my have multiple different certificates but a single certificate should be only assigned to a single user. If a certificate is assigned to multiple users no matter if in the user object or in the override the lookup will fail sooner or later.
</p>
<p>
For the indirect integration the different lookups should be tested independently on the IPA master and an IPA client because different code paths are used since SSSD is running in the ipa-server-mode on the master.
</p>
<h3 id="HowToDebug">How To Debug</h3>
<p>
Explain how to debug this feature if something goes wrong. This section might include examples of additional commands the user might run (such as keytab or certificate sanity checks) or explain what message to look for.
</p>
<h3 id="Authors">Authors</h3>
<ul><li>Sumit Bose &lt;<a class="mail-link" href="mailto:sbose@redhat.com"><span class="icon">​</span>sbose@redhat.com</a>&gt;
</li></ul></body></html>