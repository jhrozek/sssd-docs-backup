<html><head><link rel="stylesheet" href="/sssd-test2/trac.css" type="text/css" /><link rel="stylesheet" href="/sssd-test2/wiki.css" type="text/css" /></head><body><h1 id="IDmapping-AutomaticallyassignnewslicesforanyADdomain">ID mapping - Automatically assign new slices for any AD domain</h1>
<p>
Related ticket(s):
</p>
<ul><li><a class="ext-link" href="https://fedorahosted.org/sssd/ticket/2188"><span class="icon">​</span>https://fedorahosted.org/sssd/ticket/2188</a>
</li></ul><h3 id="Problemstatement">Problem statement</h3>
<p>
When a domain RID grows beyond the slice size it may make sense to have SSSD allocate a new slice automatically instead of relying on the admin to find the fault and increase the slice size in sssd.conf and then remove SYSDB cache and restart SSSD.
</p>
<h3 id="Usecases">Use cases</h3>
<p>
If RID part of Active Directories user's SID (e.g. S-1-5-21-2153326666-2176343378-3404031434-300000) is greater than value of option ldap_idmap_range_size (default: 200000) then ID mapping will not work properly for such user. To resolve such situation:
</p>
<ul><li>Administrator has to notice this happening.
</li><li>Fix configuration of ID mapping - increase value of ldap_idmap_range_size option.
</li><li>Stop SSSD, remove SYSDB cache, start SSSD.
</li></ul><p>
Downside of such configuration change is that the mapping function will change. SIDs can be mapped to different UIDs and UIDs might be mapped on different SIDs or at no SIDs at all.
</p>
<p>
For example Active Directory users might not be able to access their files on UNIX hosts any more as the files would belong to their formal UNIX IDs not the current ones.
</p>
<p>
After this feature is implemented administrator's action will not be required in most cases. Also restarting SSSD and removing SYSDB cache will not be necessary and so user ownership of resources such as files will not be lost.
</p>
<h3 id="Overviewofthesolution">Overview of the solution</h3>
<p>
After generating primary range for domain helper ranges are generated. Number of helper ranges is adjustable (new option ldap_idmap_helper_table_size). Special value 0 of this option disables this feature.
</p>
<ul><li>Unique identifier for helper ranges is a string <em>domain_sid-$first_rid</em> where $first_rid is value of the first rid for this helper range.
</li><li>This unique identifier is later passed to <em>sss_idmap_calculate_range()</em> where it is used as input for murmur hash.
</li></ul><p>
Update algorithm for mapping SID to UNIX ID:
</p>
<ul><li>After mapping using primary slice fails then generate list of all domains that SID belongs to.
</li><li>If such list is not empty then check if SID matches against secondary ranges of these domains and perform similar computation of UNIX ID as is done for primary slices. If SID is not in helper ranges new range is generated and its identifier string is <em>domain_sid-$first_rid</em> where $first_rid is <strong>((int)(RIDofSID / range_size)) * range_size</strong>.
</li></ul><p>
Update algorithm for mapping UNIX ID to SID:
</p>
<ul><li>After mapping using primary slice fails then iterate through whole list of domains.
</li><li>For each domain check all helper ranges for match with ID.
</li><li>If match is found compute SID in the same manner as is done if match is in primary slice.
</li></ul><h3 id="Implementationdetails">Implementation details</h3>
<p>
Introduce new struct <strong>idmap_range_params</strong> that holds all relevant information for slice ranges, such as:
</p>
<ul><li>uint32_t min_id - minimal unix ID in given slice
</li><li>uint32_t max_id - maximal unix ID in given slice
</li><li>char *range_id
</li><li>uint32_t first_rid
</li></ul><p>
These fields should be replaced in struct <strong>idmap_domain_info</strong> by new field struct idmap_range_params <strong>range_params</strong> that would describe primary slice assigned to this domain.
</p>
<p>
Add a linked list of struct idmap_range_params <strong>helpers</strong> into idmap_domain_info. These helpers will hold information for secondary slices assigned to this domain.
</p>
<p>
Update <strong>sss_idmap_calculate_range()</strong> to check for collision even with secondary slices.
</p>
<p>
Update <strong>sss_idmap_sid_to_unix()</strong> and <strong>sss_idmap_unix_to_sid()</strong>.
</p>
<p>
Add new function <strong>sss_idmap_add_auto_domain_ex() </strong> which is similar to  sss_idmap_add_domain_ex() but generates helper ranges for domains and also takes callbacks which can be used to store domains generated for helper ranges.
</p>
<h3 id="Configurationchanges">Configuration changes</h3>
<p>
ldap_idmap_helper_table_size (integer) - Maximal number of secondary slices that is tried when performing mapping from UNIX ID to SID.  If value of ldap_idmap_helper_table_size is equal to 0 then no additional secondary slices are generated.
</p>
<h3 id="HowToTest">How To Test</h3>
<p>
Create user in Active Directory whose RID part of SID is out of range size (value of option ldap_idmap_range_size). ID mapping should fail for such user, warning in logs should be generated and mainly lookup query should not return the user. After this feature is implemented it should be working.
</p>
<h3 id="Authors">Authors</h3>
<p>
Sumit Bose &lt;<a class="mail-link" href="mailto:sbose@redhat.com"><span class="icon">​</span>sbose@redhat.com</a>&gt;
Pavel Reichl &lt;<a class="mail-link" href="mailto:preichl@redhat.com"><span class="icon">​</span>preichl@redhat.com</a>&gt;
</p>
</body></html>